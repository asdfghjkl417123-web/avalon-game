<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AVALON: Realtime Command</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // â˜…ã“ã“ã«Firebaseã®æ§‹æˆï¼ˆConfigï¼‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
        const firebaseConfig = {
            apiKey: "AIzaSyC1Y1Cx3eiweokQyKCZ5c_PfBx5txi9Omk",
            authDomain: "avalon-game-a986b.firebaseapp.com",
            databaseURL: "https://avalon-game-a986b-default-rtdb.firebaseio.com",
            projectId: "avalon-game-a986b",
            storageBucket: "avalon-game-a986b.firebasestorage.app",
            messagingSenderId: "586338781550",
            appId: "1:586338781550:web:deeb0ce69c32ea8af8597f",
            measurementId: "G-3SD3DQVD2V"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Reactã‹ã‚‰ä½¿ãˆã‚‹ã‚ˆã†ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
        window.fb = { db, ref, set, onValue, update, remove };
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Sans+JP:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        @keyframes cardReveal {
            0% {
                transform: scale(0.8) rotateY(90deg);
                opacity: 0;
            }

            100% {
                transform: scale(1) rotateY(0deg);
                opacity: 1;
            }
        }

        /* æ•—åŒ—æ™‚ã®ç”»é¢ã®æºã‚Œæ¼”å‡º */
        @keyframes shake {
            0% {
                transform: translate(1px, 1px) rotate(0deg);
            }

            10% {
                transform: translate(-1px, -2px) rotate(-1deg);
            }

            20% {
                transform: translate(-3px, 0px) rotate(1deg);
            }

            30% {
                transform: translate(3px, 2px) rotate(0deg);
            }

            40% {
                transform: translate(1px, -1px) rotate(1deg);
            }

            50% {
                transform: translate(-1px, 2px) rotate(-1deg);
            }

            100% {
                transform: translate(1px, 1px) rotate(0deg);
            }
        }

        @keyframes loading {
            0% {
                transform: translateX(-100%);
            }

            80% {
                transform: translateX(-10%);
            }

            /* æœ€å¾Œã«å°‘ã—æºœã‚ã‚‹ */
            100% {
                transform: translateX(0);
            }
        }

        .animate-revealIdentity {
            animation: reveal 0.8s cubic-bezier(0.23, 1, 0.32, 1) both;
        }

        @keyframes reveal {
            0% {
                letter-spacing: 1em;
                opacity: 0;
                filter: blur(10px);
            }

            100% {
                letter-spacing: normal;
                opacity: 1;
                filter: blur(0);
            }
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%) rotate(35deg);
            }

            100% {
                transform: translateX(100%) rotate(35deg);
            }
        }

        /* æˆåŠŸãƒ»å¤±æ•—æ™‚ã®ã‚°ãƒ­ãƒ¼ï¼ˆç™ºå…‰ï¼‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .text-success-glow {
            color: #60a5fa;
            text-shadow: 0 0 10px #3b82f6, 0 0 20px #2563eb;
        }

        .text-fail-glow {
            color: #f87171;
            text-shadow: 0 0 10px #ef4444, 0 0 20px #dc2626;
        }

        .animate-shake {
            animation: shake 0.5s linear infinite;
        }

        .animate-cardReveal {
            animation: cardReveal 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        body {
            background-color: #0d0d0f;
            color: #e2d1a4;
            font-family: 'Noto Sans JP', sans-serif;
            overflow-x: hidden;
        }

        .font-cinzel {
            font-family: 'Cinzel', serif;
        }

        .gold-border {
            border: 1px solid #c5a059;
        }

        .gold-text {
            color: #c5a059;
        }

        .bg-dark-card {
            background-color: #1a1a1e;
            border: 1px solid #333;
        }

        .btn-gold {
            background: linear-gradient(135deg, #c5a059 0%, #8e6d2f 100%);
            color: black;
            font-weight: bold;
        }

        .btn-gold:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const QUEST_CONFIG = {
            5: [2, 3, 2, 3, 3], 6: [2, 3, 4, 3, 4], 7: [2, 3, 3, 4, 4],
            8: [3, 4, 4, 5, 5], 9: [3, 4, 4, 5, 5], 10: [3, 4, 4, 5, 5]
        };

        const ROLE_HELP = {
            'ãƒãƒ¼ãƒªãƒ³': "ã€æ­£ç¾©ã€‘é‚ªæ‚ªãªé™£å–¶ï¼ˆãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰ã‚’é™¤ãï¼‰ã®æ­£ä½“ã‚’çŸ¥ã£ã¦ã„ã¾ã™ã€‚æœ€å¾Œã«æš—æ®ºè€…ã«æ­£ä½“ã‚’è¦‹ç ´ã‚‰ã‚Œã‚‹ã¨æ•—åŒ—ã—ã¾ã™ã€‚",
            'ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«': "ã€æ­£ç¾©ã€‘ãƒãƒ¼ãƒªãƒ³ã¨ãƒ¢ãƒ«ã‚¬ãƒŠã®2åãŒã€Œãƒãƒ¼ãƒªãƒ³å€™è£œã€ã¨ã—ã¦è¦‹ãˆã¦ã„ã¾ã™ã€‚ã©ã¡ã‚‰ãŒæœ¬ç‰©ã‹è¦‹æ¥µã‚ã¦ãã ã•ã„ã€‚",
            'å¿ è‡£': "ã€æ­£ç¾©ã€‘ç‰¹åˆ¥ãªèƒ½åŠ›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è­°è«–ã¨æŠ•ç¥¨ã§æ­£ç¾©ã‚’å‹åˆ©ã«å°ã„ã¦ãã ã•ã„ã€‚",
            'æš—æ®ºè€…': "ã€é‚ªæ‚ªã€‘ä»²é–“ã®æ­£ä½“ã‚’çŸ¥ã£ã¦ã„ã¾ã™ã€‚ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã€ãƒãƒ¼ãƒªãƒ³ã‚’æŒ‡åã—ã¦æš—æ®ºã«æˆåŠŸã™ã‚Œã°é€†è»¢å‹åˆ©ã¨ãªã‚Šã¾ã™ã€‚",
            'ãƒ¢ãƒ«ã‚¬ãƒŠ': "ã€é‚ªæ‚ªã€‘ä»²é–“ã®æ­£ä½“ã‚’çŸ¥ã£ã¦ã„ã¾ã™ã€‚ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«ã«å¯¾ã—ã¦ãƒãƒ¼ãƒªãƒ³ã®ãµã‚Šã‚’ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚",
            'ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰': "ã€é‚ªæ‚ªã€‘ä»²é–“ã®æ­£ä½“ã‚’çŸ¥ã£ã¦ã„ã¾ã™ã€‚ãƒãƒ¼ãƒªãƒ³ã®ç›®ã‹ã‚‰é€ƒã‚Œã‚‹ã“ã¨ãŒã§ãã‚‹å¼·åŠ›ãªå½¹è·ã§ã™ã€‚",
            'ã‚ªãƒ™ãƒ­ãƒ³': "ã€é‚ªæ‚ªã€‘ä»²é–“ã‹ã‚‰èªè­˜ã•ã‚Œãšã€è‡ªåˆ†ã‚‚ä»²é–“ã‚’çŸ¥ã‚Šã¾ã›ã‚“ã€‚ã—ã‹ã—ã€é‚ªæ‚ªãªé™£å–¶ã®ä¸€å“¡ã¨ã—ã¦å‹•ãã¾ã™ã€‚"
        };

        function App() {
            const [roomCode, setRoomCode] = useState(localStorage.getItem('avalon_room') || "");
            const [myName, setMyName] = useState(localStorage.getItem('avalon_name') || "");
            const [isJoined, setIsJoined] = useState(false);
            const [gameState, setGameState] = useState(null);
            const [selectedPlayers, setSelectedPlayers] = useState([]);
            const [hasActioned, setHasActioned] = useState(false);
            const [showHistoryModal, setShowHistoryModal] = React.useState(false); // å±¥æ­´ç”»é¢ã®é–‹é–‰
            const [showHelp, setShowHelp] = React.useState(false);                 // å½¹è·ãƒ˜ãƒ«ãƒ—ã®é–‹é–‰
            const [revealing, setRevealing] = React.useState(false);               // æ¼”å‡ºä¸­ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
            const [displayResults, setDisplayResults] = React.useState([]);
            const [historyTab, setHistoryTab] = React.useState('quest'); // 'quest' ã‹ 'vote'
            const [isRevealingRole, setIsRevealingRole] = React.useState(false);
            const [isRevealingAssassination, setIsRevealingAssassination] = React.useState(false);
            const [isRevealingVote, setIsRevealingVote] = React.useState(false);
            const [lastVoteStatus, setLastVoteStatus] = React.useState(null); // 'approved' or 'rejected'
            const [isAssassinating, setIsAssassinating] = React.useState(false); // æ¼”å‡ºå®Ÿè¡Œä¸­
            const [isMatchPointPerforming, setIsMatchPointPerforming] = React.useState(false);
            const [wantsRematch, setWantsRematch] = React.useState(false);

            // DBã®å¤‰æ›´ã‚’ç›£è¦–ã—ã¦æ¼”å‡ºã‚’é–‹å§‹ã™ã‚‹useEffect
            // 1. ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ï¼ˆå‚åŠ è€…æ›´æ–°ãƒ»ãƒ•ã‚§ãƒ¼ã‚ºé€²è¡Œã«å¿…é ˆï¼‰
            useEffect(() => {
                if (!roomCode || !isJoined) return;
                const roomRef = window.fb.ref(window.fb.db, `rooms/${roomCode}`);

                const unsubscribe = window.fb.onValue(roomRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setGameState(data);
                    }
                });
                return () => unsubscribe();
            }, [roomCode, isJoined]);

            // è¿½åŠ ï¼šã‚²ãƒ¼ãƒ é–‹å§‹ï¼ˆå½¹è·é…å¸ƒï¼‰ã‚’å…¨å“¡ã®ç”»é¢ã§æ¤œçŸ¥ã—ã¦æ¼”å‡ºã‚’é–‹å§‹ã™ã‚‹
            useEffect(() => {
                // 1. ã‚²ãƒ¼ãƒ ãŒé–‹å§‹(started: true)ã•ã‚ŒãŸ
                // 2. ã¾ã æ¼”å‡ºã‚’è¡¨ç¤ºã—ã¦ã„ãªã„(isRevealingRoleãŒfalse)
                if (gameState?.started && !isRevealingRole) {
                    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦ã€ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã«ä½•åº¦ã‚‚å‡ºãªã„ã‚ˆã†ã«åˆ¶å¾¡
                    const hasSeen = sessionStorage.getItem(`revealed_${roomCode}`);
                    if (!hasSeen) {
                        setIsRevealingRole(true);
                        sessionStorage.setItem(`revealed_${roomCode}`, 'true');
                    }
                }
            }, [gameState?.started]);

            // --- è¿½åŠ ï¼šæŠ•ç¥¨çµæœã‚’å…¨å“¡ã®ç”»é¢ã§ä¸€æ–‰ã«å‡ºã™ ---
            useEffect(() => {
                // lastVoteId ãŒæ›´æ–°ã•ã‚ŒãŸã‚‰ã€ãã®æ™‚ã® status ã‚’å–å¾—ã—ã¦æ¼”å‡ºã‚’é–‹å§‹
                if (gameState?.lastVoteId && gameState?.lastVoteStatus) {
                    setLastVoteStatus(gameState.lastVoteStatus);
                    setIsRevealingVote(true);

                    const timer = setTimeout(() => {
                        setIsRevealingVote(false);
                    }, 2500);

                    return () => clearTimeout(timer);
                }
            }, [gameState?.lastVoteId]); // lastVoteId ã®å¤‰åŒ–ã‚’ç›£è¦–

            // 3. æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã«é€²ã‚“ã ã‚‰ãƒœã‚¿ãƒ³ã‚’å†ã³æŠ¼ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹
            useEffect(() => {
                setHasActioned(false);
            }, [gameState?.phase, gameState?.voteCount, gameState?.currentQuest]);

            // â‘¡ é å¾çµæœæ¼”å‡ºã®åŒæœŸ
            useEffect(() => {
                // tempResultsãŒå­˜åœ¨ã—ã€ã‹ã¤ã€Œæ¿€ã‚¢ãƒ„æ¼”å‡ºä¸­ã€ã§ãªã„æ™‚ã ã‘ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã‚Šå§‹ã‚ã‚‹
                if (gameState?.tempResults && !revealing && !gameState?.isQuestPerforming) {
                    startRevealSequence(gameState.tempResults);
                }
            }, [gameState?.tempResults, gameState?.isQuestPerforming]);

            // ãƒãƒƒãƒãƒã‚¤ãƒ³ãƒˆæ¼”å‡ºã®ç›£è¦–
            useEffect(() => {
                setIsMatchPointPerforming(!!gameState?.isQuestPerforming);
            }, [gameState?.isQuestPerforming]);

            // æš—æ®ºé–‹å§‹ã¨æœ€çµ‚çµæœã®æ¼”å‡ºãƒˆãƒªã‚¬ãƒ¼
            useEffect(() => {
                if (gameState?.phase === 'assassination') {
                    setIsRevealingAssassination(true);
                    // 3ç§’å¾Œã«æ¼”å‡ºã‚’é–‰ã˜ã€æš—æ®ºè€…ã®æ“ä½œç”»é¢ã‚’å‡ºã™
                    const timer = setTimeout(() => setIsRevealingAssassination(false), 3000);
                    return () => clearTimeout(timer);
                }
            }, [gameState?.phase]);

            useEffect(() => {
                if (gameState?.isAssassinationPerforming) {
                    setIsAssassinating(true);
                    // éŸ³å£°ã‚’å‡ºã™ãªã‚‰ã“ã“ï¼ˆã‚¸ãƒ£ã‚¸ãƒ£ãƒ¼ãƒ³ï¼ã¨ã„ã†SEãªã©ï¼‰
                } else {
                    setIsAssassinating(false);
                }
            }, [gameState?.isAssassinationPerforming]);

            // æ¼”å‡ºã®ä¸­èº«ï¼ˆstartRevealSequenceï¼‰
            const startRevealSequence = (resultsArray) => {
                setRevealing(true);
                let currentShown = [];

                resultsArray.forEach((res, index) => {
                    setTimeout(() => {
                        currentShown.push(res);
                        setDisplayResults([...currentShown]);

                        if (currentShown.length === resultsArray.length) {
                            setTimeout(() => {
                                setRevealing(false);
                                setDisplayResults([]);
                                // ãƒªãƒ¼ãƒ€ãƒ¼ã®ã¿ãŒä¸€åº¦ã ã‘DBã‚’æ›´æ–°ã—ã¦æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã¸é€ã‚‹
                                if (gameState.currentLeader === myName) {
                                    finishQuestLogic(resultsArray);
                                }
                            }, 2000);
                        }
                    }, (index + 1) * 1000);
                });
            };

            const finishQuestLogic = (resultsArray) => {
                const fails = resultsArray.filter(v => v === 'fail').length;
                const isQ4Special = (gameState.currentQuest === 4 && gameState.playerList.length >= 7);
                const success = isQ4Special ? fails < 2 : fails < 1;

                const newResults = [...(gameState.questResults || []), success ? 'success' : 'fail'];
                const newHistoryEntry = {
                    team: [...gameState.proposedTeam],
                    result: success ? 'success' : 'fail',
                    details: resultsArray.map(r => r === 'success' ? 'â—‹' : 'Ã—').join(" ")
                };
                const updatedHistory = [...(gameState.questHistory || []), newHistoryEntry];
                const nextLeaderIdx = (gameState.playerList.indexOf(gameState.currentLeader) + 1) % gameState.playerList.length;

                let nextPhase = 'propose';
                let winner = null;


                if (newResults.filter(r => r === 'fail').length >= 3) {
                    nextPhase = 'end';
                    winner = 'EVIL';
                } else if (newResults.filter(r => r === 'success').length >= 3) {
                    nextPhase = 'assassination';
                }

                dbUpdate({
                    phase: nextPhase,
                    winner: winner,
                    currentQuest: nextPhase === 'propose' ? gameState.currentQuest + 1 : gameState.currentQuest,
                    currentLeader: gameState.playerList[nextLeaderIdx],
                    questResults: newResults,
                    questHistory: updatedHistory,
                    tempResults: null, // æ¼”å‡ºç”¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»
                    questData: {},     // æå‡ºãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
                    voteCount: 0,
                    logs: addLog(`ç¬¬${gameState.currentQuest}é å¾çµæœ: ${success ? "æˆåŠŸ" : "å¤±æ•—"} [${newHistoryEntry.details}]`)
                });
            };

            const dbUpdate = (updates) => {
                const roomRef = window.fb.ref(window.fb.db, `rooms/${roomCode}`);
                window.fb.update(roomRef, updates);
            };

            const addLog = (msg) => {
                const currentLogs = gameState?.logs || [];
                return [...currentLogs, `[${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}] ${msg}`].slice(-20);
            };

            const joinGame = () => {
                if (!roomCode || !myName) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
                localStorage.setItem('avalon_room', roomCode);
                localStorage.setItem('avalon_name', myName);
                setIsJoined(true);
                const playersRef = window.fb.ref(window.fb.db, `rooms/${roomCode}/players/${myName}`);
                window.fb.set(playersRef, { joined: true });
            };

            const startGame = () => {
                const players = Object.keys(gameState.players);
                if (players.length < 5) return alert("5äººä»¥ä¸Šå¿…è¦ã§ã™");

                // å®‰å…¨ãªå½¹è·é…å¸ƒãƒ­ã‚¸ãƒƒã‚¯
                let baseRoles = ['ãƒãƒ¼ãƒªãƒ³', 'ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«', 'å¿ è‡£', 'æš—æ®ºè€…', 'ãƒ¢ãƒ«ã‚¬ãƒŠ'];
                if (players.length >= 6) baseRoles.push('å¿ è‡£');
                if (players.length >= 7) baseRoles.push('ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰');
                if (players.length >= 8) baseRoles.push('å¿ è‡£');
                if (players.length >= 9) baseRoles.push('å¿ è‡£');
                if (players.length >= 10) baseRoles.push('ã‚ªãƒ™ãƒ­ãƒ³');

                const shuffled = baseRoles.sort(() => Math.random() - 0.5);
                const playerMap = {};
                players.forEach((p, i) => { playerMap[p] = shuffled[i]; });

                dbUpdate({
                    started: true,
                    phase: 'propose',
                    playerMap,
                    playerList: players,
                    currentLeader: players[0],
                    currentQuest: 1,
                    voteCount: 0,
                    questResults: [],
                    logs: [`[${new Date().toLocaleTimeString()}] è–æˆ¦ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ`]
                });
                setIsRevealingRole(true);
            };

            // ç‰¹æ®Šæƒ…å ±ã®å–å¾—ãƒ­ã‚¸ãƒƒã‚¯
            const getSeenInfo = () => {
                if (!gameState || !gameState.playerMap) return null;
                const myRole = gameState.playerMap[myName];
                const info = [];
                const evilRoles = ['æš—æ®ºè€…', 'ãƒ¢ãƒ«ã‚¬ãƒŠ', 'ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰', 'ã‚ªãƒ™ãƒ­ãƒ³'];
                const seenByMerlin = ['æš—æ®ºè€…', 'ãƒ¢ãƒ«ã‚¬ãƒŠ', 'ã‚ªãƒ™ãƒ­ãƒ³'];

                Object.entries(gameState.playerMap).forEach(([name, role]) => {
                    if (name === myName) return;
                    if (myRole === 'ãƒãƒ¼ãƒªãƒ³' && seenByMerlin.includes(role)) info.push(`${name}: é‚ªæ‚ª`);
                    if (myRole === 'ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«' && ['ãƒãƒ¼ãƒªãƒ³', 'ãƒ¢ãƒ«ã‚¬ãƒŠ'].includes(role)) info.push(`${name}: ãƒãƒ¼ãƒªãƒ³å€™è£œ`);
                    if (['æš—æ®ºè€…', 'ãƒ¢ãƒ«ã‚¬ãƒŠ', 'ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰'].includes(myRole) && ['æš—æ®ºè€…', 'ãƒ¢ãƒ«ã‚¬ãƒŠ', 'ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰'].includes(role)) info.push(`${name}: ä»²é–“`);
                });
                return info;
            };

            const proposeTeam = () => {
                dbUpdate({
                    phase: 'voting',
                    proposedTeam: selectedPlayers,
                    votes: {},
                    logs: addLog(`${myName}ãŒé å¾ãƒ¡ãƒ³ãƒãƒ¼ã‚’ææ¡ˆ: ${selectedPlayers.join(", ")}`)
                });
                setSelectedPlayers([]);
            };

            // æŠ•ç¥¨ï¼ˆæ‰¿èªãƒ»å´ä¸‹ï¼‰ã®ä¿®æ­£
            const castVote = (choice) => {
                if (hasActioned) return;
                setHasActioned(true);

                const newVotes = { ...(gameState.votes || {}), [myName]: choice };

                // å…¨å“¡ã®æŠ•ç¥¨ãŒæƒã£ãŸã‹ãƒã‚§ãƒƒã‚¯
                if (Object.keys(newVotes).length === gameState.playerList.length) {
                    const yesCount = Object.values(newVotes).filter(v => v === 'yes').length;
                    const approved = yesCount > gameState.playerList.length / 2;

                    // æŠ•ç¥¨è©³ç´°ã®æ–‡å­—åˆ—ï¼ˆå±¥æ­´è¡¨ç¤ºç”¨ï¼‰
                    const voteDetails = Object.entries(newVotes)
                        .map(([name, v]) => `${name}:${v === 'yes' ? 'â—‹' : 'Ã—'}`)
                        .join("  ");

                    const newVoteRecord = {
                        quest: gameState.currentQuest,
                        count: (gameState.voteCount || 0) + 1,
                        leader: gameState.currentLeader,
                        team: [...gameState.proposedTeam],
                        details: voteDetails,
                        approved: approved
                    };
                    const updatedVoteHistory = [...(gameState.voteHistory || []), newVoteRecord];

                    // --- å…¨å“¡ä¸€æ–‰æ¼”å‡ºã®ãŸã‚ã®åŒæœŸç”¨ãƒ‡ãƒ¼ã‚¿ ---
                    const syncStatus = approved ? 'approved' : 'rejected'; // æ–‡å­—åˆ—ã‚’å›ºå®š
                    const syncId = Date.now();

                    const baseUpdate = {
                        votes: {}, // æ¬¡å›ã®ãŸã‚ã«æŠ•ç¥¨ã‚’ã‚¯ãƒªã‚¢
                        lastVoteStatus: syncStatus, // æ¼”å‡ºåˆ¤å®šç”¨ã®æ–‡å­—åˆ—
                        lastVoteId: syncId,         // useEffectç™ºç«ç”¨ã®ãƒˆãƒªã‚¬ãƒ¼
                        lastVoteResult: voteDetails, // è©³ç´°è¡¨ç¤ºç”¨
                        voteHistory: updatedVoteHistory,
                    };

                    if (approved) {
                        dbUpdate({
                            ...baseUpdate,
                            phase: 'quest',
                            questData: {},
                            actions: {},
                            logs: addLog(`ææ¡ˆæ‰¿èª (${yesCount}ç¥¨)ã€‚é å¾ã¸ã€‚`)
                        });
                    } else {
                        const idx = (gameState.playerList.indexOf(gameState.currentLeader) + 1) % gameState.playerList.length;
                        const count = (gameState.voteCount || 0) + 1;
                        dbUpdate({
                            ...baseUpdate,
                            phase: count >= 5 ? 'end' : 'propose',
                            winner: count >= 5 ? 'EVIL' : null,
                            currentLeader: gameState.playerList[idx],
                            voteCount: count >= 5 ? 0 : count,
                            logs: addLog(count >= 5 ? "5å›å´ä¸‹ã«ã‚ˆã‚Šé‚ªæ‚ªã®å‹åˆ©" : `ææ¡ˆå´ä¸‹ã€‚ãƒªãƒ¼ãƒ€ãƒ¼äº¤ä»£`)
                        });
                    }
                } else {
                    dbUpdate({ votes: newVotes });
                }
            };

            const questAction = (choice) => {
                if (hasActioned) return;
                setHasActioned(true);

                const myRole = gameState.playerMap[myName];
                const isEvil = ['æš—æ®ºè€…', 'ãƒ¢ãƒ«ã‚¬ãƒŠ', 'ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰', 'ã‚ªãƒ™ãƒ­ãƒ³'].includes(myRole);
                const finalChoice = isEvil ? choice : 'success';

                const newData = { ...(gameState.questData || {}), [myName]: finalChoice };
                const team = gameState.proposedTeam;

                if (Object.keys(newData).length === team.length) {
                    const shuffledResults = Object.values(newData).sort(() => Math.random() - 0.5);

                    // ãƒãƒƒãƒãƒã‚¤ãƒ³ãƒˆåˆ¤å®šï¼ˆã©ã¡ã‚‰ã‹ãŒ2å‹ã—ã¦ã„ã‚‹ï¼‰
                    const goodWins = (gameState.questResults || []).filter(r => r === 'success').length;
                    const evilWins = (gameState.questResults || []).filter(r => r === 'fail').length;
                    const isMatchPoint = (goodWins === 2 || evilWins === 2);

                    if (isMatchPoint) {
                        // â‘  ã¾ãšã€Œæ¿€ã‚¢ãƒ„æ¼”å‡ºã€ãƒ•ãƒ©ã‚°ã ã‘ã‚’ç«‹ã¦ã‚‹
                        dbUpdate({
                            questData: newData,
                            isQuestPerforming: true,
                            questPerformingId: Date.now()
                        });

                        // â‘¡ 6ç§’å¾Œã«ã€Œæ¿€ã‚¢ãƒ„æ¼”å‡ºã€ã‚’æ¶ˆã—ã€åŒæ™‚ã«ã€Œã‚«ãƒ¼ãƒ‰ã‚ãã‚Šãƒ‡ãƒ¼ã‚¿ã€ã‚’æŠ•å…¥
                        setTimeout(() => {
                            dbUpdate({
                                isQuestPerforming: false,
                                tempResults: shuffledResults // ã“ã“ã§åˆã‚ã¦ã‚«ãƒ¼ãƒ‰ãŒä¸¦ã³å§‹ã‚ã‚‹
                            });
                        }, 6000);
                    } else {
                        // é€šå¸¸æ™‚ã¯å³åº§ã«ã‚«ãƒ¼ãƒ‰ã‚ãã‚Šã¸
                        dbUpdate({
                            questData: newData,
                            tempResults: shuffledResults
                        });
                    }
                } else {
                    dbUpdate({ questData: newData });
                }
            };

            const assassinate = (target) => {
                const targetRole = gameState.playerMap[target];
                if (targetRole === 'ãƒãƒ¼ãƒªãƒ³') dbUpdate({ phase: 'end', winner: 'EVIL', logs: addLog(`æš—æ®ºæˆåŠŸï¼ãƒãƒ¼ãƒªãƒ³(${target})ã¯å€’ã‚Œã¾ã—ãŸã€‚é‚ªæ‚ªã®å‹åˆ©ï¼`) });
                else dbUpdate({ phase: 'end', winner: 'GOOD', logs: addLog(`æš—æ®ºå¤±æ•—ï¼${target}ã¯ãƒãƒ¼ãƒªãƒ³ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ­£ç¾©ã®å‹åˆ©ï¼`) });
            };

            const handleReset = () => {
                setWantsRematch(false); // è¿½åŠ 
                setHasActioned(false);  // è¿½åŠ 
                if (confirm("ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
                    // æ¬¡å›ã‚²ãƒ¼ãƒ æ™‚ã«ã¾ãŸæ¼”å‡ºãŒè¦‹ã‚Œã‚‹ã‚ˆã†ã«ãƒ•ãƒ©ã‚°ã‚’æ¶ˆã™
                    sessionStorage.removeItem(`revealed_${roomCode}`);
                    window.fb.remove(window.fb.ref(window.fb.db, `rooms/${roomCode}`));
                    location.reload();
                }
            };

            const executeAssassination = (targetName) => {
                const isMerlin = gameState.playerMap[targetName] === 'ãƒãƒ¼ãƒªãƒ³';

                dbUpdate({
                    assassinationTarget: targetName,
                    isAssassinationPerforming: true,
                    assassinationId: Date.now()
                });

                setTimeout(() => {
                    dbUpdate({
                        phase: 'end',
                        winner: isMerlin ? 'EVIL' : 'GOOD',
                        isAssassinationPerforming: false,
                        logs: addLog(isMerlin ? `æš—æ®ºæˆåŠŸï¼ãƒãƒ¼ãƒªãƒ³ã¯${targetName}ã ã£ãŸã€‚` : `æš—æ®ºå¤±æ•—ï¼${targetName}ã¯ãƒãƒ¼ãƒªãƒ³ã§ã¯ãªã‹ã£ãŸã€‚`)
                    });
                }, 5000);
            };

            const handleRematch = () => {
                if (!gameState || wantsRematch) return;

                // è‡ªåˆ†ã®ãƒœã‚¿ãƒ³ã‚’ã€Œå¾…æ©Ÿä¸­ã€ã«å¤‰ãˆã‚‹
                setWantsRematch(true);
                // é‡è¦ï¼šæ¬¡ã®ã‚²ãƒ¼ãƒ ã§ã€Œã™ã§ã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ¸ˆã¿ã€åˆ¤å®šã«ãªã‚‰ãªã„ã‚ˆã†ã«ãƒªã‚»ãƒƒãƒˆ
                setHasActioned(false);

                const newRematchVotes = { ...(gameState.rematchVotes || {}), [myName]: true };

                if (Object.keys(newRematchVotes).length === gameState.playerList.length) {
                    dbUpdate({
                        started: false,
                        phase: 'propose',
                        currentQuest: 1,
                        voteCount: 1, // åˆæœŸå€¤ã‚’1ã«è¨­å®š
                        questResults: [],
                        playerMap: {},
                        votes: {},
                        questData: {},
                        tempResults: null,
                        rematchVotes: {}, // å…¨å“¡ã®å†æˆ¦å¸Œæœ›ã‚’ãƒªã‚»ãƒƒãƒˆ
                        logs: addLog("=== æ–°ã—ã„ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¾ã™ ===")
                    });
                } else {
                    dbUpdate({ rematchVotes: newRematchVotes });
                }
            };

            if (!isJoined) return (
                <div className="flex flex-col items-center justify-center h-screen space-y-8 fade-in">
                    <h1 className="text-6xl font-cinzel gold-text tracking-widest drop-shadow-lg">AVALON</h1>
                    <div className="bg-dark-card p-8 rounded-lg gold-border w-80 space-y-4 shadow-2xl">
                        <input className="w-full bg-black border border-gray-700 p-3 rounded" placeholder="ROOM CODE" value={roomCode} onChange={e => setRoomCode(e.target.value)} />
                        <input className="w-full bg-black border border-gray-700 p-3 rounded" placeholder="YOUR NAME" value={myName} onChange={e => setMyName(e.target.value)} />
                        <button onClick={joinGame} className="w-full btn-gold py-3 rounded hover:brightness-125 transition-all">ENTER GAME</button>
                    </div>
                </div>
            );

            const seenInfo = getSeenInfo();

            return (
                <div className="max-w-md mx-auto p-4 space-y-4 fade-in">
                    <header className="flex justify-between items-center border-b border-[#c5a059] pb-2">
                        <div className="font-cinzel text-xl gold-text tracking-tighter">AVALON COMMAND</div>
                        <button onClick={handleReset} className="text-[10px] text-red-500 border border-red-900 px-2 py-1 rounded">RESET</button>
                    </header>

                    {!gameState?.started ? (
                        <div className="bg-dark-card p-6 rounded-lg text-center space-y-4">
                            <p className="text-sm">
                                å‚åŠ è€…: {gameState && gameState.players ? Object.keys(gameState.players).join(", ") : myName}
                            </p>
                            <button onClick={startGame} className="w-full btn-gold py-3 rounded shadow-lg">GAME START</button>
                        </div>
                    ) : (
                        <div className="space-y-4">

                            {/* å½¹è·ãƒ»ç‰¹æ®Šæƒ…å ±ã‚¨ãƒªã‚¢ */}
                            <div className="bg-dark-card p-4 rounded-lg gold-border flex justify-between items-start relative">
                                <div>
                                    <div className="flex items-center gap-2 mb-1">
                                        <h3 className="text-[10px] uppercase opacity-50 tracking-widest leading-none">Your Role</h3>
                                        <button
                                            onClick={() => setShowHelp(true)}
                                            className="w-4 h-4 rounded-full border border-gold/50 text-[10px] flex items-center justify-center text-gold hover:bg-gold/20 transition-all"
                                        >
                                            ?
                                        </button>
                                    </div>
                                    <p className="text-2xl font-cinzel text-white leading-none">{gameState.playerMap?.[myName]}</p>
                                </div>

                                {seenInfo && seenInfo.length > 0 && (
                                    <div className="text-[10px] text-right text-yellow-200 opacity-80 bg-yellow-900/20 p-2 rounded">
                                        <p className="font-bold border-b border-yellow-900/50 mb-1 italic">Knowledge</p>
                                        {seenInfo.map((inf, idx) => <p key={idx}>{inf}</p>)}
                                    </div>
                                )}
                            </div>

                            {/* ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã®ä¸Šã®ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */}
                            <div className="flex gap-2 mb-4">
                                <button
                                    onClick={() => { setHistoryTab('quest'); setShowHistoryModal(true); }}
                                    className="flex-1 py-2 border border-red-500/30 bg-red-500/5 text-red-400 text-[10px] rounded uppercase tracking-widest font-bold"
                                >
                                    ğŸ“œ Quest Logs
                                </button>
                                <button
                                    onClick={() => { setHistoryTab('vote'); setShowHistoryModal(true); }}
                                    className="flex-1 py-2 border border-blue-500/30 bg-blue-500/5 text-blue-400 text-[10px] rounded uppercase tracking-widest font-bold"
                                >
                                    ğŸ—³ï¸ Vote Logs
                                </button>
                            </div>

                            {/* ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ */}
                            <div className="grid grid-cols-5 gap-1">
                                {[1, 2, 3, 4, 5].map(i => (
                                    <div key={i} className={`h-12 flex flex-col items-center justify-center rounded border ${gameState.questResults?.[i - 1] === 'success' ? 'bg-blue-900 border-blue-400' : gameState.questResults?.[i - 1] === 'fail' ? 'bg-red-900 border-red-400' : 'bg-gray-900 opacity-30'} ${gameState.currentQuest === i ? 'border-yellow-400 border-2' : 'border-gray-700'}`}>
                                        <span className="text-[8px]">Q{i}</span>
                                        <span className="text-xs font-bold">{QUEST_CONFIG[gameState.playerList.length]?.[i - 1]}äºº</span>
                                    </div>
                                ))}
                            </div>

                            {/* ã‚¯ã‚¨ã‚¹ãƒˆå±¥æ­´ãƒªã‚¹ãƒˆ */}
                            {gameState.questHistory && gameState.questHistory.length > 0 && (
                                <div className="bg-black/60 rounded-lg border border-gray-800 overflow-hidden mb-4">
                                    <div className="bg-gray-900/50 px-3 py-1 border-b border-gray-800 flex justify-between items-center">
                                        <span className="text-[10px] text-gray-400 uppercase tracking-widest font-bold">Quest History</span>
                                        <span className="text-[9px] text-gray-500 italic">é å¾ã®è¨˜éŒ²</span>
                                    </div>
                                    <div className="divide-y divide-gray-800">
                                        {gameState.questHistory.map((h, idx) => (
                                            <div key={idx} className="px-3 py-2 flex items-center justify-between animate-fadeIn">
                                                <div className="flex items-center gap-3">
                                                    <span className={`w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold ${h.result === 'success' ? 'bg-blue-900/50 text-blue-400 border border-blue-500/30' : 'bg-red-900/50 text-red-400 border border-red-500/30'}`}>
                                                        Q{idx + 1}
                                                    </span>
                                                    <div className="flex flex-wrap gap-1">
                                                        {h.team.map(member => (
                                                            <span key={member} className="text-[11px] bg-gray-800 px-1.5 py-0.5 rounded text-gray-300 border border-gray-700">
                                                                {member}
                                                            </span>
                                                        ))}
                                                    </div>
                                                </div>
                                                <span className={`text-[10px] font-bold ${h.result === 'success' ? 'text-blue-400' : 'text-red-400'}`}>
                                                    {h.result === 'success' ? 'SUCCESS' : 'FAIL'}
                                                </span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* å´ä¸‹ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®è¡¨ç¤º */}
                            <div className="flex justify-between items-center bg-black/40 p-2 rounded border border-red-900/30">
                                <span className="text-[10px] text-red-400 uppercase tracking-widest">æŠ•ç¥¨å¤±æ•—å›æ•°</span>
                                <div className="flex gap-1">
                                    {[1, 2, 3, 4, 5].map(i => (
                                        <div key={i} className={`w-3 h-3 rounded-full border ${gameState.voteCount >= i ? 'bg-red-600 border-red-400' : 'bg-gray-800 border-gray-600'}`}></div>
                                    ))}
                                </div>
                            </div>

                            {/* ç›´å‰ã®æŠ•ç¥¨çµæœ (Last Vote) */}
                            {gameState.lastVoteResult && (
                                <div className="bg-blue-900/10 rounded border border-blue-500/20 overflow-hidden mb-4">
                                    <div className="bg-blue-900/30 px-2 py-1 flex justify-between items-center">
                                        <span className="text-[9px] text-blue-300 font-bold uppercase tracking-widest">Last Vote Reveal</span>
                                        <span className="text-[8px] text-blue-400 opacity-70">å‰å›ã®æŠ•ç¥¨å†…è¨³</span>
                                    </div>
                                    <div className="p-2 flex flex-wrap gap-2 justify-center">
                                        {gameState.lastVoteResult.split("  ").map((vote, i) => {
                                            const [name, sign] = vote.split(":");
                                            return (
                                                <div key={i} className={`flex flex-col items-center min-w-[50px] p-1 rounded border ${sign === 'â—‹' ? 'bg-green-900/20 border-green-500/30' : 'bg-red-900/20 border-red-500/30'}`}>
                                                    <span className="text-[10px] text-gray-300 truncate w-full text-center">{name}</span>
                                                    <span className={`text-sm font-bold ${sign === 'â—‹' ? 'text-green-400' : 'text-red-400'}`}>
                                                        {sign === 'â—‹' ? 'æ‰¿èª' : 'å´ä¸‹'}
                                                    </span>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}


                            {/* ãƒ¡ã‚¤ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ */}
                            <div className="bg-dark-card p-5 rounded-lg border-l-4 border-[#c5a059] shadow-xl min-h-[160px] flex flex-col justify-center">
                                {gameState.phase === 'propose' && (
                                    <div className="space-y-3">
                                        <p className="text-sm text-center font-bold">
                                            {gameState.currentLeader === myName ? "ã‚ãªãŸãŒãƒªãƒ¼ãƒ€ãƒ¼ã§ã™ã€‚ãƒ¡ãƒ³ãƒãƒ¼é¸å®šä¸­..." : `ãƒªãƒ¼ãƒ€ãƒ¼ ${gameState.currentLeader} ãŒé¸å®šä¸­...`}
                                        </p>
                                        {gameState.currentLeader === myName && (
                                            <div className="space-y-3">
                                                <div className="flex flex-wrap gap-2 justify-center">
                                                    {gameState.playerList.map(p => (
                                                        <button key={p} onClick={() => setSelectedPlayers(s => s.includes(p) ? s.filter(x => x !== p) : [...s, p])} className={`px-3 py-1 text-xs rounded-full border transition ${selectedPlayers.includes(p) ? 'bg-blue-600 border-blue-400' : 'bg-black border-gray-600'}`}>{p}</button>
                                                    ))}
                                                </div>
                                                <button disabled={selectedPlayers.length !== QUEST_CONFIG[gameState.playerList.length][gameState.currentQuest - 1]} onClick={proposeTeam} className="w-full btn-gold py-2 rounded text-sm shadow-md">ãƒãƒ¼ãƒ ææ¡ˆã‚’é€ä¿¡</button>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {gameState.phase === 'voting' && (
                                    <div className="text-center space-y-4">
                                        <p className="text-sm">ææ¡ˆãƒãƒ¼ãƒ : <span className="text-white font-bold">{gameState.proposedTeam.join(", ")}</span></p>
                                        <div className="flex gap-4">
                                            <button
                                                disabled={hasActioned} // â˜…ã“ã“ã‚’è¿½åŠ 
                                                onClick={() => castVote('yes')}
                                                className={`flex-1 py-4 rounded font-bold transition-all ${hasActioned ? 'bg-gray-800 opacity-50' : 'bg-green-700 hover:bg-green-600 shadow-[0_0_15px_rgba(34,197,94,0.3)]'
                                                    }`}
                                            >
                                                {hasActioned ? "æå‡ºæ¸ˆ" : "æ‰¿èª"}
                                            </button>

                                            <button
                                                disabled={hasActioned} // â˜…ã“ã“ã‚’è¿½åŠ 
                                                onClick={() => castVote('no')}
                                                className={`flex-1 py-4 rounded font-bold transition-all ${hasActioned ? 'bg-gray-800 opacity-50' : 'bg-red-900 hover:bg-red-800 shadow-[0_0_15px_rgba(239,68,68,0.3)]'
                                                    }`}
                                            >
                                                {hasActioned ? "æå‡ºæ¸ˆ" : "å´ä¸‹"}
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {gameState.phase === 'quest' && (
                                    <div className="text-center space-y-6 py-4">
                                        {/* --- 3ç•ªï¼šçµåˆãƒã‚¤ãƒ³ãƒˆï¼ˆæ¼”å‡ºãƒ•ãƒ©ã‚°ã§åˆ†å²ï¼‰ --- */}
                                        {revealing ? (
                                            /* è±ªè¯ãªã‚«ãƒ¼ãƒ‰ã‚ãã‚Šæ¼”å‡ºç”»é¢ */
                                            <div className="fixed inset-0 z-[100] bg-black/95 flex flex-col items-center justify-center p-6 animate-fadeIn">
                                                <h2 className="font-cinzel text-xl gold-text mb-8 tracking-[0.3em] animate-pulse">REVEALING FATE</h2>

                                                <div className="flex gap-3 flex-wrap justify-center mb-8">
                                                    {/* é å¾ãƒ¡ãƒ³ãƒãƒ¼ã®äººæ•°åˆ†ã ã‘ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º */}
                                                    {Array.from({ length: gameState.proposedTeam.length }).map((_, i) => {
                                                        const res = displayResults[i]; // æ¼”å‡ºç”¨ã®1æšãšã¤ã®çµæœ
                                                        return (
                                                            <div key={i} className={`w-16 h-24 border-2 flex items-center justify-center transition-all duration-500 transform shadow-lg
                                ${res ? (res === 'success' ? 'bg-blue-900 border-blue-400 rotate-0 scale-105' : 'bg-red-900 border-red-400 rotate-0 scale-105')
                                                                    : 'bg-gray-900 border-gray-700 rotate-12 scale-90 opacity-50'}`}>
                                                                {res && (
                                                                    <span className="text-3xl font-bold text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">
                                                                        {res === 'success' ? 'â—‹' : 'Ã—'}
                                                                    </span>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>

                                                {/* ã™ã¹ã¦ã‚ãã‚Šçµ‚ã‚ã£ãŸæ™‚ã®æœ€çµ‚åˆ¤å®šãƒ†ã‚­ã‚¹ãƒˆï¼šã“ã“ã‚’å·®ã—æ›¿ãˆ */}
                                                {displayResults.length === gameState.proposedTeam.length && (
                                                    <div className="text-center space-y-2">
                                                        <p className={`text-4xl font-cinzel font-bold tracking-[0.2em] drop-shadow-lg ${displayResults.filter(r => r === 'fail').length >= (gameState.currentQuest === 4 && gameState.playerList.length >= 7 ? 2 : 1)
                                                            ? 'text-fail-glow animate-shake' : 'text-success-glow'
                                                            }`}>
                                                            {displayResults.filter(r => r === 'fail').length >= (gameState.currentQuest === 4 && gameState.playerList.length >= 7 ? 2 : 1)
                                                                ? 'QUEST FAILED' : 'QUEST SUCCESS'}
                                                        </p>

                                                        {/* å¤±æ•—æ•°ã‚‚è¡¨ç¤ºã™ã‚‹ã¨åˆ†ã‹ã‚Šã‚„ã™ã„ã§ã™ */}
                                                        <p className="text-[10px] text-gray-400 uppercase tracking-widest">
                                                            {displayResults.filter(r => r === 'fail').length} Failure card(s) detected
                                                        </p>

                                                        <p className="text-[10px] text-gold/60 mt-4 animate-pulse uppercase tracking-tighter">Archiving Results to Chronicle...</p>
                                                    </div>
                                                )}
                                            </div>
                                        ) : (
                                            /* --- æ—¢å­˜ã®UIï¼ˆå¾…æ©Ÿä¸­ or ãƒœã‚¿ãƒ³æ“ä½œï¼‰ --- */
                                            <>
                                                <div className="mb-2">
                                                    <p className="text-[10px] text-gray-500 uppercase tracking-widest mb-2">Quest Progress</p>
                                                    <div className="py-6 bg-black/40 rounded-lg border border-white/5">
                                                        <div className="relative inline-block">
                                                            <div className="animate-spin inline-block w-8 h-8 border-[3px] border-gold/20 border-t-gold rounded-full"></div>
                                                        </div>
                                                        <p className="text-xs text-gold mt-4 font-cinzel tracking-widest animate-pulse">
                                                            ENVOYS ARE CHOOSING FATE...
                                                        </p>
                                                        <p className="text-[10px] text-gray-500 mt-1">ï¼ˆé å¾ãƒ¡ãƒ³ãƒãƒ¼ãŒé‹å‘½ã‚’é¸æŠä¸­ï¼‰</p>
                                                    </div>
                                                </div>

                                                {gameState.proposedTeam.includes(myName) ? (
                                                    <div className="space-y-4 pt-4 border-t border-gray-800">
                                                        <p className="text-xs font-bold text-blue-400">
                                                            {hasActioned ? "æ„æ€è¡¨ç¤ºã‚’å®Œäº†ã—ã¾ã—ãŸ" : "ã‚ãªãŸã®é‹å‘½ã‚’é¸æŠã—ã¦ãã ã•ã„"}
                                                        </p>

                                                        <div className="flex gap-4">
                                                            <button
                                                                disabled={hasActioned}
                                                                onClick={() => questAction('success')}
                                                                className={`flex-1 py-5 rounded-none font-bold transition-all border ${hasActioned
                                                                    ? 'bg-gray-900 border-gray-800 text-gray-600 opacity-50'
                                                                    : 'bg-blue-900/40 border-blue-500 text-blue-100 hover:bg-blue-600'
                                                                    }`}
                                                            >
                                                                {hasActioned ? "æå‡ºæ¸ˆ" : "æˆ åŠŸ"}
                                                            </button>

                                                            <button
                                                                disabled={hasActioned}
                                                                onClick={() => questAction('fail')}
                                                                className={`flex-1 py-5 rounded-none font-bold transition-all border ${hasActioned
                                                                    ? 'bg-gray-900 border-gray-800 text-gray-600 opacity-50'
                                                                    : 'bg-red-900/40 border-red-500 text-red-100 hover:bg-red-600'
                                                                    }`}
                                                            >
                                                                {hasActioned ? "æå‡ºæ¸ˆ" : "å¤± æ•—"}
                                                            </button>
                                                        </div>

                                                        <p className="text-[10px] text-gray-500 italic leading-tight px-4 bg-gray-900/50 py-2 rounded">
                                                            â€»æ­£ç¾©ã®é™£å–¶ï¼ˆå–„å´ï¼‰ã¯ã€ã©ã¡ã‚‰ã®ãƒœã‚¿ãƒ³ã‚’é¸æŠã—ã¦ã‚‚è‡ªå‹•çš„ã«ã€ŒæˆåŠŸã€ã¨ã—ã¦é›†è¨ˆã•ã‚Œã¾ã™ã€‚
                                                        </p>
                                                    </div>
                                                ) : (
                                                    <div className="py-10 text-xs text-gray-500 border-t border-gray-800 italic">
                                                        ã‚ãªãŸã¯é å¾ã‚’è¦‹å®ˆã£ã¦ã„ã¾ã™...<br />
                                                        (å¯©åˆ¤ã®æ™‚ã‚’å¾…ã¦)
                                                    </div>
                                                )}
                                            </>
                                        )}
                                    </div>
                                )}

                                {gameState.phase === 'assassination' && (
                                    <div className="text-center space-y-4">
                                        <p className="text-sm text-red-400 font-bold">ã€æš—æ®ºãƒ•ã‚§ãƒ¼ã‚ºã€‘</p>
                                        {gameState.playerMap[myName] === 'æš—æ®ºè€…' ? (
                                            <div className="space-y-3">
                                                <p className="text-xs">ãƒãƒ¼ãƒªãƒ³ã ã¨æ€ã†äººç‰©ã‚’æŒ‡åã—ã¦ãã ã•ã„</p>
                                                <div className="flex flex-wrap gap-2 justify-center">
                                                    {gameState.playerList.filter(p => p !== myName).map(p => (
                                                        <button key={p} onClick={() => executeAssassination(name)} className="px-4 py-2 bg-red-900 border border-red-500 rounded text-xs">æš—æ®º: {p}</button>
                                                    ))}
                                                </div>
                                            </div>
                                        ) : <p className="animate-pulse">æš—æ®ºè€…ã®æ±ºæ–­ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>}
                                    </div>
                                )}

                                {gameState.phase === 'end' && (
                                    <div className="fixed inset-0 z-[300] bg-black/95 flex flex-col items-center justify-center p-6 animate-fadeIn backdrop-blur-sm">
                                        <div className={`text-center space-y-6 max-w-sm w-full p-8 border-2 rounded-lg shadow-2xl ${gameState.winner === 'GOOD' ? 'border-blue-500/50 bg-blue-900/10' : 'border-red-600/50 bg-red-900/10'}`}>

                                            {/* ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ï¼šå‹æ•—ã«ã‚ˆã£ã¦è‰²ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¤‰ãˆã‚‹ */}
                                            <div className="space-y-2">
                                                <p className={`text-5xl font-cinzel tracking-[0.2em] font-bold ${gameState.winner === 'GOOD' ? 'text-blue-400 drop-shadow-[0_0_15px_rgba(59,130,246,0.5)]' : 'text-red-500 drop-shadow-[0_0_15px_rgba(220,38,38,0.5)] animate-shake'}`}>
                                                    {gameState.winner === 'GOOD' ? 'VICTORY' : 'DEFEAT'}
                                                </p>
                                                <p className="text-lg font-bold text-white tracking-widest">
                                                    {gameState.winner === 'GOOD' ? 'æ­£ç¾©ã®è»å‹¢ã®å‹åˆ©' : 'é‚ªæ‚ªãªé­”åŠ›ã®å‹åˆ©'}
                                                </p>
                                            </div>

                                            {/* æ±ºç€ã®ç†ç”±ã‚’è¡¨ç¤ºã™ã‚‹ãƒãƒƒã‚¸ */}
                                            <div className="py-2 px-4 bg-white/5 rounded-full inline-block border border-white/10">
                                                <p className="text-[10px] text-gray-400 uppercase tracking-[0.2em]">
                                                    {gameState.winner === 'EVIL' ? (
                                                        gameState.questResults?.filter(r => r === 'fail').length >= 3
                                                            ? "ğŸ“œ é å¾ãŒ3å›å¤±æ•—ã—ãŸ"
                                                            : "ğŸ”ª ãƒãƒ¼ãƒªãƒ³ãŒæš—æ®ºã•ã‚ŒãŸ"
                                                    ) : (
                                                        "ğŸ›¡ï¸ é å¾æˆåŠŸ ï¼† æš—æ®ºé˜»æ­¢"
                                                    )}
                                                </p>
                                            </div>

                                            {/* çœŸå®Ÿã®è¨˜éŒ²ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆï¼‰ */}
                                            <div className="bg-black/60 p-4 rounded-lg border border-white/10 space-y-2">
                                                <p className="text-[10px] text-gold/60 uppercase tracking-widest mb-3 border-b border-white/10 pb-1">Archive of Truth</p>
                                                <div className="space-y-2 max-h-[30vh] overflow-y-auto custom-scrollbar pr-2">
                                                    {Object.entries(gameState.playerMap).map(([name, role]) => (
                                                        <div key={name} className="flex justify-between items-center border-b border-white/5 py-1.5 text-sm">
                                                            <span className="text-gray-200 font-medium">{name}</span>
                                                            <span className={`font-cinzel text-xs font-bold ${['æš—æ®ºè€…', 'ãƒ¢ãƒ«ã‚¬ãƒŠ', 'ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰', 'ã‚ªãƒ™ãƒ­ãƒ³'].includes(role) ? 'text-red-400' : 'text-blue-400'}`}>
                                                                {role}
                                                            </span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* ãƒ­ã‚°ã‚¨ãƒªã‚¢ */}
                            <div className="bg-black/80 p-3 h-40 overflow-y-auto rounded border border-gray-800 text-[10px] space-y-1">
                                {gameState.logs?.slice().reverse().map((l, i) => (
                                    <p key={i} className="border-b border-gray-900 pb-1 text-gray-400">
                                        <span className="text-[#c5a059]">{l}</span>
                                    </p>
                                ))}
                            </div>
                        </div>
                    )}
                    {/* å…¨å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« */}
                    {showHistoryModal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 backdrop-blur-md">
                            <div className="absolute inset-0 bg-black/90" onClick={() => setShowHistoryModal(false)}></div>
                            <div className="relative bg-[#0d0d0f] border-2 border-gray-800 w-full max-w-md max-h-[85vh] overflow-hidden flex flex-col shadow-2xl">

                                {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
                                <div className="p-4 border-b border-gray-800 bg-gray-900/50 flex justify-between items-center">
                                    <h3 className="font-cinzel text-lg gold-text tracking-widest">KINGDOM ARCHIVES</h3>
                                    <button onClick={() => setShowHistoryModal(false)} className="text-gray-500 text-2xl">&times;</button>
                                </div>

                                {/* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã‚¹ã‚¤ãƒƒãƒ */}
                                <div className="flex border-b border-gray-800">
                                    <button
                                        onClick={() => setHistoryTab('quest')}
                                        className={`flex-1 py-3 text-[10px] font-bold uppercase tracking-widest transition-all ${historyTab === 'quest' ? 'text-gold border-b-2 border-gold bg-gold/5' : 'text-gray-500'}`}
                                    >
                                        ğŸ“œ Quest Logs
                                    </button>
                                    <button
                                        onClick={() => setHistoryTab('vote')}
                                        className={`flex-1 py-3 text-[10px] font-bold uppercase tracking-widest transition-all ${historyTab === 'vote' ? 'text-blue-400 border-b-2 border-blue-400 bg-blue-400/5' : 'text-gray-500'}`}
                                    >
                                        ğŸ—³ï¸ Vote Logs
                                    </button>
                                </div>

                                {/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */}
                                <div className="flex-1 overflow-y-auto p-4 custom-scrollbar bg-black/20">
                                    {historyTab === 'quest' ? (
                                        /* é å¾ãƒ­ã‚° */
                                        <div className="space-y-4 animate-fadeIn">
                                            {gameState.questHistory && gameState.questHistory.length > 0 ? (
                                                gameState.questHistory.map((qh, i) => (
                                                    <div key={i} className="bg-white/5 p-4 border-l-4 border-red-500/50 rounded-r shadow-inner">
                                                        <div className="flex justify-between items-center mb-2">
                                                            <span className="text-[12px] text-gray-300 font-cinzel">QUEST 0{i + 1}</span>
                                                            <span className={`px-2 py-0.5 rounded text-[10px] font-bold ${qh.result === 'success' ? 'bg-blue-900 text-blue-200' : 'bg-red-900 text-red-200'}`}>
                                                                {qh.result === 'success' ? "SUCCESS" : "FAILED"}
                                                            </span>
                                                        </div>
                                                        <div className="space-y-1">
                                                            <p className="text-[11px] text-gray-400"><span className="text-gold/50">TEAM:</span> {qh.team.join(", ")}</p>
                                                            <p className="text-[10px] text-gray-500 font-mono tracking-widest pt-1 border-t border-white/5">RESULT: {qh.details}</p>
                                                        </div>
                                                    </div>
                                                ))
                                            ) : (
                                                <div className="text-center py-20 text-gray-600 italic text-xs">No quest records found in the archives.</div>
                                            )}
                                        </div>
                                    ) : (
                                        /* æŠ•ç¥¨ãƒ­ã‚° */
                                        <div className="space-y-3 animate-fadeIn">
                                            {gameState.voteHistory && gameState.voteHistory.length > 0 ? (
                                                [...gameState.voteHistory].reverse().map((vh, i) => (
                                                    <div key={i} className="bg-white/5 p-3 border-l-4 border-blue-500/50 rounded-r shadow-inner">
                                                        <div className="flex justify-between items-center mb-1">
                                                            <span className="text-[10px] text-gray-400 font-bold uppercase tracking-tighter">Q{vh.quest} - Attempt {vh.count}</span>
                                                            <span className={`text-[10px] font-bold ${vh.approved ? "text-green-500" : "text-red-500"}`}>
                                                                {vh.approved ? "APPROVED" : "REJECTED"}
                                                            </span>
                                                        </div>
                                                        <p className="text-[11px] text-gray-300 mb-2 font-medium">Leader: {vh.leader}</p>
                                                        <div className="text-[9px] text-gray-500 bg-black/40 p-2 rounded leading-relaxed break-all font-mono border border-white/5">
                                                            {vh.details}
                                                        </div>
                                                    </div>
                                                ))
                                            ) : (
                                                <div className="text-center py-20 text-gray-600 italic text-xs">No voting history recorded yet.</div>
                                            )}
                                        </div>
                                    )}
                                </div>

                                <button onClick={() => setShowHistoryModal(false)} className="p-4 bg-gray-900 text-white text-[10px] font-bold uppercase tracking-[0.2em] hover:bg-black transition-colors">
                                    Return to Command
                                </button>
                            </div>
                        </div>
                    )}
                    {/* å½¹è·ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« */}
                    {showHelp && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-6">
                            <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" onClick={() => setShowHelp(false)}></div>
                            <div className="relative bg-[#1a1a1e] border-2 border-[#c5a059] p-6 w-full max-w-sm shadow-[0_0_50px_rgba(197,160,89,0.2)]">
                                <h4 className="font-cinzel gold-text text-xl mb-2">{gameState.playerMap?.[myName]}ã®å°ã</h4>
                                <p className="text-sm text-gray-300 leading-relaxed mb-6">
                                    {ROLE_HELP[gameState.playerMap?.[myName]]}
                                </p>

                                <div className="space-y-2 mb-6">
                                    <p className="text-[10px] text-gold uppercase tracking-tighter border-b border-gold/30">é™£å–¶ã®ç›¸é–¢</p>
                                    <div className="text-[11px] text-gray-400">
                                        {gameState.playerMap?.[myName] === 'ãƒãƒ¼ãƒªãƒ³' && "è¦‹ãˆã‚‹ç›¸æ‰‹: æš—æ®ºè€…, ãƒ¢ãƒ«ã‚¬ãƒŠ, ã‚ªãƒ™ãƒ­ãƒ³"}
                                        {gameState.playerMap?.[myName] === 'ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«' && "è¦‹ãˆã‚‹ç›¸æ‰‹: ãƒãƒ¼ãƒªãƒ³, ãƒ¢ãƒ«ã‚¬ãƒŠ"}
                                        {['æš—æ®ºè€…', 'ãƒ¢ãƒ«ã‚¬ãƒŠ', 'ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰'].includes(gameState.playerMap?.[myName]) && "è¦‹ãˆã‚‹ç›¸æ‰‹: é‚ªæ‚ªãªä»²é–“ï¼ˆã‚ªãƒ™ãƒ­ãƒ³ä»¥å¤–ï¼‰"}
                                        {['å¿ è‡£', 'ã‚ªãƒ™ãƒ­ãƒ³'].includes(gameState.playerMap?.[myName]) && "è¦‹ãˆã‚‹ç›¸æ‰‹: ãªã—"}
                                    </div>
                                </div>

                                <button
                                    onClick={() => setShowHelp(false)}
                                    className="w-full py-2 bg-gold text-black font-bold text-sm uppercase"
                                >
                                    é–‰ã˜ã‚‹
                                </button>
                            </div>
                        </div>
                    )}
                    {/* å½¹è·åˆ¤æ˜æ¼”å‡ºãƒ¢ãƒ¼ãƒ€ãƒ« */}
                    {isRevealingRole && (
                        <div className="fixed inset-0 z-[200] bg-black flex flex-col items-center justify-center p-8 animate-fadeIn">
                            <div className="text-center space-y-8 max-w-xs w-full">
                                <h2 className="text-gold font-cinzel text-sm tracking-[0.5em] animate-pulse">IDENTITY ASSIGNED</h2>

                                {/* ã‚«ãƒ¼ãƒ‰ã®èƒŒé¢ã‹ã‚‰è¡¨é¢ã¸ã²ã£ãã‚Šè¿”ã‚‹ã‚ˆã†ãªæ¼”å‡º */}
                                <div className="relative w-48 h-64 mx-auto perspective-1000">
                                    <div className="w-full h-full bg-gradient-to-b from-gold/20 to-transparent border-2 border-gold/50 rounded-lg flex flex-col items-center justify-center p-6 shadow-[0_0_30px_rgba(212,175,55,0.2)] animate-cardReveal">
                                        <p className="text-[10px] text-gold/60 uppercase tracking-widest mb-2">You Are</p>
                                        <h3 className="text-3xl font-cinzel text-white font-bold mb-4 text-center">
                                            {gameState.playerMap?.[myName]}
                                        </h3>
                                        <div className="w-12 h-0.5 bg-gold/30 mb-4"></div>
                                        <p className="text-[11px] text-gray-400 leading-relaxed italic">
                                            {['æš—æ®ºè€…', 'ãƒ¢ãƒ«ã‚¬ãƒŠ', 'ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰', 'ã‚ªãƒ™ãƒ­ãƒ³'].includes(gameState.playerMap?.[myName])
                                                ? "é‚ªæ‚ªã®è»å‹¢ã¨ã—ã¦ã€ã‚¢ãƒ¼ã‚µãƒ¼ã®å¿ è‡£ã‚’æ¬ºãã€é å¾ã‚’é˜»æ­¢ã›ã‚ˆã€‚"
                                                : "ã‚¢ãƒ¼ã‚µãƒ¼ç‹ã®å¿ è‡£ã¨ã—ã¦ã€è–æ¯ã‚’æ±‚ã‚ã€é‚ªæ‚ªãªå½±ã‚’æš´ãå‡ºã›ã€‚"}
                                        </p>
                                    </div>
                                </div>

                                <button
                                    onClick={() => setIsRevealingRole(false)}
                                    className="w-full py-4 bg-white/5 border border-white/20 text-white font-cinzel text-xs tracking-widest hover:bg-white/10 transition-all"
                                >
                                    UNDERSTOOD
                                </button>
                            </div>
                        </div>
                    )}

                    {/* æŠ•ç¥¨çµæœã®å…¨ç”»é¢æ¼”å‡º */}
                    {isRevealingVote && (
                        <div className="fixed inset-0 z-[280] flex flex-col items-center justify-center animate-fadeIn backdrop-blur-sm bg-black/40">
                            <div className={`transform scale-150 p-8 rounded-lg border-2 shadow-[0_0_50px_rgba(0,0,0,0.5)] ${lastVoteStatus === 'approved' // ã“ã“ãŒ 'approved' ãªã‚‰é’
                                ? 'bg-blue-900/90 border-blue-400 text-blue-100'
                                : 'bg-red-900/90 border-red-500 text-red-100'   // ãã‚Œä»¥å¤–ï¼ˆrejectedï¼‰ãªã‚‰èµ¤
                                }`}>
                                <h2 className="font-cinzel text-4xl tracking-[0.4em] font-bold animate-cardReveal">
                                    {lastVoteStatus === 'approved' ? 'APPROVED' : 'REJECTED'}
                                </h2>
                                <p className="text-[10px] mt-2 tracking-[0.2em] opacity-80 uppercase text-center">
                                    {lastVoteStatus === 'approved' ? 'é å¾éƒ¨éšŠã€å‡ºç™º' : 'ææ¡ˆã¯é€€ã‘ã‚‰ã‚ŒãŸ'}
                                </p>
                            </div>
                        </div>
                    )}

                    {/* ãƒãƒƒãƒãƒã‚¤ãƒ³ãƒˆé å¾ã®æ¿€ã‚¢ãƒ„ã‚«ãƒƒãƒˆã‚¤ãƒ³ */}
                    {isMatchPointPerforming && (
                        <div className="fixed inset-0 z-[500] bg-black flex flex-col items-center justify-center overflow-hidden">
                            {/* èƒŒæ™¯ã®æ¿€ã—ã„ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ */}
                            <div className="absolute inset-0 bg-gold/10 animate-pulse"></div>
                            <div className="absolute inset-0 border-[20px] border-double border-gold/30 animate-ping"></div>

                            <div className="relative z-10 text-center">
                                <p className="text-gold font-cinzel text-xl tracking-[0.5em] animate-bounce">
                                    CRITICAL QUEST
                                </p>
                                <h2 className="text-7xl font-cinzel font-bold text-white italic tracking-tighter shadow-gold drop-shadow-[0_0_20px_rgba(255,215,0,0.8)]">
                                    é‹å‘½ã®å¯©åˆ¤
                                </h2>
                                <div className="mt-8 flex gap-4 justify-center">
                                    <div className="w-12 h-12 rounded-full border-2 border-blue-500 animate-spin"></div>
                                    <div className="w-12 h-12 rounded-full border-2 border-red-500 animate-[spin_1.5s_linear_infinite_reverse]"></div>
                                </div>
                                <p className="mt-8 text-white/60 font-bold tracking-widest animate-pulse">
                                    æ±ºç€ã®æ™‚ãŒæ¥ãŸ...
                                </p>
                            </div>

                            {/* ç”»é¢ã‚’æ–œã‚ã«èµ°ã‚‹å…‰ã®ãƒ©ã‚¤ãƒ³ */}
                            <div className="absolute top-0 left-[-100%] w-[300%] h-[100%] bg-gradient-to-r from-transparent via-white/20 to-transparent rotate-[35deg] animate-[shimmer_2s_infinite]"></div>
                        </div>
                    )}

                    {/* æš—æ®ºé–‹å§‹ã®è­¦å‘Šæ¼”å‡º */}
                    {isRevealingAssassination && (
                        <div className="fixed inset-0 z-[250] bg-red-950/90 flex flex-col items-center justify-center p-8 animate-fadeIn backdrop-blur-md">
                            <div className="text-center space-y-4">
                                <div className="text-red-500 text-6xl mb-4 animate-bounce">ğŸ”ª</div>
                                <h2 className="text-white font-cinzel text-3xl tracking-[0.3em] font-bold">ASSASSINATION</h2>
                                <p className="text-red-300 font-bold tracking-widest animate-pulse">é‚ªæ‚ªã®é€†è»¢åŠ‡ãŒå§‹ã¾ã‚‹...</p>
                            </div>
                        </div>
                    )}

                    {isAssassinating && (
                        <div className="fixed inset-0 z-[400] bg-black flex flex-col items-center justify-center overflow-hidden">
                            {/* èƒŒæ™¯ã®èµ°æŸ»ç·šãƒ»ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æ¼”å‡º */}
                            <div className="absolute inset-0 bg-red-900/20 animate-pulse"></div>

                            <div className="relative z-10 text-center space-y-8">
                                {/* ã‚«ãƒƒãƒˆã‚¤ãƒ³ */}
                                <div className="animate-revealIdentity">
                                    <p className="text-gold text-xs tracking-[0.5em] mb-2 uppercase">Assassination in Progress</p>
                                    <h2 className="text-6xl font-cinzel font-bold text-white tracking-tighter">
                                        TARGET: <span className="text-red-600 underline">{gameState.assassinationTarget}</span>
                                    </h2>
                                </div>

                                {/* é‹å‘½ã®ã‚¿ãƒ¡ï¼ˆãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ï¼‰ */}
                                <div className="w-64 h-1 bg-white/10 mx-auto overflow-hidden relative">
                                    <div className="absolute inset-0 bg-red-600 animate-[loading_5s_ease-in-out]"></div>
                                </div>

                                <div className="text-white font-bold italic animate-pulse tracking-widest text-lg">
                                    CHECKING IDENTITY...
                                </div>
                            </div>

                            {/* ç¨²å¦»ã®ã‚ˆã†ãªã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆCSSã§è¿½åŠ ï¼‰ */}
                            <div className="absolute top-0 left-0 w-full h-full pointer-events-none opacity-30 bg-[radial-gradient(circle,transparent_20%,black_100%)]"></div>
                        </div>
                    )}

                    {/* æœ€çµ‚çµæœï¼ˆå‹æ•—æ±ºå®šï¼‰ã®è±ªè¯æ¼”å‡º */}
                    {gameState?.phase === 'end' && (
                        <div className="fixed inset-0 z-[300] bg-black/95 flex flex-col items-center justify-center p-6 animate-fadeIn backdrop-blur-md">
                            <div className={`text-center space-y-6 max-w-sm w-full p-8 border-2 rounded-lg shadow-2xl ${gameState.winner === 'GOOD' ? 'border-blue-500/50 bg-blue-900/10' : 'border-red-600/50 bg-red-900/10'}`}>

                                <div className="space-y-2">
                                    <p className={`text-5xl font-cinzel tracking-[0.2em] font-bold ${gameState.winner === 'GOOD' ? 'text-blue-400 drop-shadow-[0_0_15px_rgba(59,130,246,0.5)]' : 'text-red-500 drop-shadow-[0_0_15px_rgba(220,38,38,0.5)]'}`}>
                                        {gameState.winner === 'GOOD' ? 'VICTORY' : 'DEFEAT'}
                                    </p>
                                    <p className="text-lg font-bold text-white tracking-widest">
                                        {gameState.winner === 'GOOD' ? 'æ­£ç¾©ã®è»å‹¢ã®å‹åˆ©' : 'é‚ªæ‚ªãªé­”åŠ›ã®å‹åˆ©'}
                                    </p>
                                </div>

                                {/* æ±ºç€ã®ç†ç”±ã‚’åˆ¤å®šã—ã¦è¡¨ç¤º */}
                                <div className="py-2 px-4 bg-white/5 rounded-full inline-block border border-white/10">
                                    <p className="text-[10px] text-gray-400 uppercase tracking-[0.2em]">
                                        {gameState.winner === 'EVIL' ? (
                                            gameState.questResults?.filter(r => r === 'fail').length >= 3
                                                ? "ğŸ“œ é å¾å¤±æ•—ã«ã‚ˆã‚‹æ•—åŒ—"
                                                : gameState.voteCount >= 5
                                                    ? "âš–ï¸ 5å›é€£ç¶šã®ææ¡ˆå´ä¸‹"
                                                    : "ğŸ”ª ãƒãƒ¼ãƒªãƒ³ãŒæš—æ®ºã•ã‚ŒãŸ"
                                        ) : (
                                            "ğŸ›¡ï¸ é å¾æˆåŠŸ ï¼† æš—æ®ºå›é¿"
                                        )}
                                    </p>
                                </div>

                                {/* çœŸå®Ÿã®è¨˜éŒ²ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆï¼‰ */}
                                <div className="bg-black/60 p-4 rounded-lg border border-white/10 space-y-2">
                                    <p className="text-[10px] text-gold/60 uppercase tracking-widest mb-3 border-b border-white/10 pb-1">Archive of Truth</p>
                                    <div className="space-y-2 max-h-[30vh] overflow-y-auto custom-scrollbar pr-2 text-left">
                                        {Object.entries(gameState.playerMap).map(([name, role]) => (
                                            <div key={name} className="flex justify-between items-center border-b border-white/5 py-1.5 text-sm">
                                                <span className="text-gray-200">{name}</span>
                                                <span className={`font-cinzel text-xs font-bold ${['æš—æ®ºè€…', 'ãƒ¢ãƒ«ã‚¬ãƒŠ', 'ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰', 'ã‚ªãƒ™ãƒ­ãƒ³'].includes(role) ? 'text-red-400' : 'text-blue-400'}`}>
                                                    {role}
                                                </span>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* è±ªè¯ãªãƒªã‚¶ãƒ«ãƒˆç”»é¢ã®ä¸­ */}
                                <div className="flex flex-col gap-3 w-full mt-6">
                                    {/* å¤ã„ RETURN TO COMMAND ãƒœã‚¿ãƒ³ã‚’æ¶ˆã—ã¦ã€ã“ã‚Œã«å·®ã—æ›¿ãˆã‚‹ */}
                                    <button
                                        onClick={handleRematch}
                                        disabled={wantsRematch}
                                        className={`w-full py-4 rounded font-cinzel text-xs tracking-[0.3em] font-bold transition-all border shadow-lg ${wantsRematch
                                                ? 'bg-gray-600/50 border-gray-500 text-gray-400 cursor-not-allowed'
                                                : gameState.winner === 'GOOD'
                                                    ? 'bg-blue-600/20 border-blue-400 text-blue-100 hover:bg-blue-600/40'
                                                    : 'bg-red-600/20 border-red-500 text-red-100 hover:bg-red-600/40'
                                            }`}
                                    >
                                        {wantsRematch
                                            ? `WAITING... (${Object.keys(gameState.rematchVotes || {}).length}/${gameState.playerList.length})`
                                            : 'REMATCH (å…¨å“¡åŒæ„ã§é–‹å§‹)'}
                                    </button>

                                    <button
                                        onClick={handleReset}
                                        className="w-full py-2 text-gray-500 font-cinzel text-[10px] tracking-widest hover:text-white transition-all opacity-60 hover:opacity-100"
                                    >
                                        EXIT TO TITLE
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const checkFB = setInterval(() => { if (window.fb) { clearInterval(checkFB); ReactDOM.createRoot(document.getElementById('root')).render(<App />); } }, 100);
    </script>
</body>

</html>
