<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AVALON: Realtime Command</title>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Sans+JP:wght@400;700&display=swap"
        rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, get, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC1Y1Cx3eiweokQyKCZ5c_PfBx5txi9Omk",
            authDomain: "avalon-game-a986b.firebaseapp.com",
            databaseURL: "https://avalon-game-a986b-default-rtdb.firebaseio.com",
            projectId: "avalon-game-a986b",
            storageBucket: "avalon-game-a986b.firebasestorage.app",
            messagingSenderId: "586338781550",
            appId: "1:586338781550:web:deeb0ce69c32ea8af8597f",
            measurementId: "G-3SD3DQVD2V"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        window.fb = { db, ref, set, onValue, update, remove, get, runTransaction };
    </script>

    <style>
        /* デザインシステム: アヴァロンの世界観を定義 */
        body {
            background-color: #0d0d0f;
            color: #e2d1a4;
            font-family: 'Noto Sans JP', sans-serif;
            overflow-x: hidden;
        }

        .font-cinzel {
            font-family: 'Cinzel', serif;
        }

        .gold-text {
            color: #c5a059;
        }

        .gold-border {
            border: 1px solid #c5a059;
        }

        .bg-dark-card {
            background-color: #1a1a1e;
            border: 1px solid #333;
        }

        /* 黄金グラデーションボタン */
        .btn-gold {
            background: linear-gradient(135deg, #c5a059 0%, #8e6d2f 100%);
            color: black;
            font-weight: bold;
            transition: opacity 0.2s;
        }

        .btn-gold:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .player-tag {
            background: rgba(197, 160, 89, 0.1);
            border: 1px solid rgba(197, 160, 89, 0.3);
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .player-tag.is-me {
            background: rgba(197, 160, 89, 0.3);
            border-color: #c5a059;
            font-weight: bold;
        }

        /* アニメーション */
        @keyframes cardReveal {
            0% {
                transform: scale(0.8) rotateY(90deg);
                opacity: 0;
            }

            100% {
                transform: scale(1) rotateY(0deg);
                opacity: 1;
            }
        }

        .animate-cardReveal {
            animation: cardReveal 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes reveal {
            0% {
                letter-spacing: 1em;
                opacity: 0;
                filter: blur(10px);
            }

            100% {
                letter-spacing: normal;
                opacity: 1;
                filter: blur(0);
            }
        }

        .animate-revealIdentity {
            animation: reveal 0.8s cubic-bezier(0.23, 1, 0.32, 1) both;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translate(0, 0);
            }

            20% {
                transform: translate(-3px, 0);
            }

            40% {
                transform: translate(3px, 0);
            }

            80% {
                transform: translate(1px, -1px);
            }
        }

        .animate-shake {
            animation: shake 0.5s linear infinite;
        }

        .text-success-glow {
            color: #60a5fa;
            text-shadow: 0 0 10px #3b82f6;
        }

        .text-fail-glow {
            color: #f87171;
            text-shadow: 0 0 10px #ef4444;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes loading {
            from {
                width: 100%;
            }

            to {
                width: 0%;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 1. 定数データ (ゲームバランスの設定) ---
        const DEFAULT_CONFIG = {
            5: { members: [2, 3, 2, 3, 3], failsRequired: [1, 1, 1, 1, 1] },
            6: { members: [2, 3, 4, 3, 4], failsRequired: [1, 1, 1, 1, 1] },
            7: { members: [2, 3, 3, 4, 4], failsRequired: [1, 1, 1, 2, 1] },
            8: { members: [3, 4, 4, 5, 5], failsRequired: [1, 1, 1, 2, 1] }, // 3回目を1枚に修正
            9: { members: [3, 4, 4, 5, 5], failsRequired: [1, 1, 1, 2, 1] },
            10: { members: [3, 4, 4, 5, 5], failsRequired: [1, 1, 1, 2, 1] }
        };

        const ROLE_HELP = {
            'マーリン': "【正義】邪悪な陣営（モードレッドを除く）の正体を知っています。暗殺者に正体を見破られると敗北します。",
            'パーシヴァル': "【正義】マーリンとモルガナの2名が「マーリン候補」として見えています。",
            '忠臣': "【正義】特別な能力はありません。議論と投票で正義を勝利に導いてください。",
            '暗殺者': "【邪悪】ゲーム終了時、マーリンを指名して暗殺に成功すれば逆転勝利となります。",
            'モルガナ': "【邪悪】パーシヴァルに対してマーリンのふりをして表示されます。",
            'モードレッド': "【邪悪】マーリンの目から逃れることができる強力な役職です。",
            'オベロン': "【邪悪】仲間から認識されず、自分も仲間を知りません。"
        };

        function App() {
            // --- 1. ユーザー情報・基本設定 ---
            const [myUid] = useState(() => {
                let uid = localStorage.getItem('camelot_uid');
                if (!uid) {
                    uid = 'kn-' + Math.random().toString(36).substring(2, 15);
                    localStorage.setItem('camelot_uid', uid);
                }
                return uid;
            });
            const [roomCode, setRoomCode] = useState(localStorage.getItem('avalon_room') || "");
            const [myName, setMyName] = useState(localStorage.getItem('avalon_name') || "");
            const [isJoined, setIsJoined] = useState(false);
            const [gameState, setGameState] = useState(null);

            // --- 2. 状態管理 (UI制御・演出フラグ) ---
            const [selectedPlayers, setSelectedPlayers] = useState([]);
            const [showStartConfirm, setShowStartConfirm] = useState(false);
            const [hasSeenRole, setHasSeenRole] = useState(false);
            const [hasActioned, setHasActioned] = useState(false);
            const [displayResults, setDisplayResults] = useState([]);
            const [revealing, setRevealing] = useState(false);
            const [showHistoryModal, setShowHistoryModal] = useState(false);
            const [showHelp, setShowHelp] = useState(false);
            const [isRevealingRole, setIsRevealingRole] = useState(false);
            const [showEndResult, setShowEndResult] = useState(true);
            const [isRevealingVote, setIsRevealingVote] = useState(false);
            const [lastVoteStatus, setLastVoteStatus] = useState(null);
            const [isAssassinating, setIsAssassinating] = useState(false);
            const [isRevealingAssassination, setIsRevealingAssassination] = useState(false);
            const [isMatchPointPerforming, setIsMatchPointPerforming] = useState(false);
            const [historyTab, setHistoryTab] = useState('quest');
            const [voteConfirm, setVoteConfirm] = useState(null);
            const [questConfirm, setQuestConfirm] = useState(null);
            const [gameConfig, setGameConfig] = useState(DEFAULT_CONFIG);
            const [isHost, setIsHost] = useState(false);
            const [selectedRoles, setSelectedRoles] = useState(['マーリン', '暗殺者', 'パーシヴァル', 'モルガナ', '忠臣']);
            const [assassinationTarget, setAssassinationTarget] = useState(null);

            const [discussionTime, setDiscussionTime] = useState(300); // 初期値：5分（300秒）
            const [timeLeft, setTimeLeft] = useState(null); // 表示用の残り時間

            const pCount = gameState?.playerList?.length || Object.keys(gameState?.players || {}).length || 5;

            // --- 3. 共通DB処理 ---
            const dbUpdate = (updates) => {
                if (!roomCode) return;
                const roomRef = window.fb.ref(window.fb.db, `rooms/${roomCode}`);

                // すべての更新に「最終活動時刻」を刻印（伝説の風化を防ぐ礎）
                const updatesWithTimestamp = {
                    ...updates,
                    lastActivity: Date.now()
                };
                window.fb.update(roomRef, updatesWithTimestamp);
            };

            // タイマー増減ロジックの追加
            const adjustTimer = (offsetSeconds) => {
                if (!isHost || !gameState?.discussionEndTime) return;
                const newEndTime = gameState.discussionEndTime + (offsetSeconds * 1000);
                if (newEndTime < Date.now()) {
                    stopDiscussionTimer();
                } else {
                    dbUpdate({ discussionEndTime: newEndTime });
                }
            };

            // 遠征メンバー数調整用ロジック
            const adjustMemberCount = (questIdx, delta) => {
                if (!isHost) return;
                // 現在の設定を取得
                const currentConf = gameState?.gameConfig || gameConfig;
                const newConfig = JSON.parse(JSON.stringify(currentConf));
                const currentVal = newConfig[pCount].members[questIdx];
                const nextVal = currentVal + delta;

                // バリデーション: 1人以上、現在の参加騎士数(pCount)以下に制限
                if (nextVal >= 1 && nextVal <= pCount) {
                    newConfig[pCount].members[questIdx] = nextVal;
                    setGameConfig(newConfig);
                    // 設定更新を即座にFirebaseへ同期
                    window.fb.update(window.fb.ref(window.fb.db, `rooms/${roomCode}`), {
                        gameConfig: newConfig
                    });
                }
            };

            const addLog = (msg) => {
                // 既存のログを取得（なければ空配列）
                const currentLogs = gameState?.logs || [];
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const newEntry = `[${time}] ${msg}`;

                // 新しいエントリーを先頭に結合し、最新20件を残す
                return [newEntry, ...currentLogs].slice(0, 20);
            };

            // --- 4. 副作用 (Firebase監視 & 演出同期) ---
            useEffect(() => {
                if (!roomCode || !isJoined) return;
                const roomRef = window.fb.ref(window.fb.db, `rooms/${roomCode}`);

                const unsubscribe = window.fb.onValue(roomRef, (snapshot) => {
                    const data = snapshot.val();

                    // A. 部屋自体がない場合
                    if (!data) {
                        setIsJoined(false);
                        return;
                    }

                    // B. 【最優先】UID（真の名）の厳格チェック
                    if (data.players && data.players[myName]) {
                        const registeredUid = data.players[myName].uid;
                        if (registeredUid && registeredUid !== myUid) {
                            alert("真の名（UID）の不一致。聖域から追放されました。");
                            setIsJoined(false);
                            return;
                        }
                    }

                    // C. 除外判定（ゲーム開始前かつリストにいない場合）
                    if (!data.started && data.players) {
                        if (!Object.keys(data.players).includes(myName)) {
                            // gameStateが存在する＝既に入室していた状態からの消失のみキック
                            if (gameState) {
                                alert("遠征軍から除外されました。");
                                setIsJoined(false);
                                return;
                            }
                        }
                    }

                    // D. データのセット（情報の開示）
                    setGameState(data);

                    // E. ホスト権限の同期
                    if (data.host === myName && data.hostUid === myUid) {
                        setIsHost(true);
                    } else {
                        // ホストが不在の場合の自動修復
                        const playerNames = Object.keys(data.players || {});
                        if (!data.host && playerNames[0] === myName) {
                            window.fb.update(roomRef, { host: myName, hostUid: myUid });
                            setIsHost(true);
                        } else {
                            setIsHost(false);
                        }
                    }

                    // F. 【重要】役職演出の発火ロジック
                    if (data.started) {
                        const alreadyRevealed = sessionStorage.getItem(`revealed_${roomCode}`);
                        // まだ演出を見ていない場合のみ表示
                        if (!alreadyRevealed) {
                            setIsRevealingRole(true);
                            // 表示したことを記録（リロードしても二度と出ない）
                            sessionStorage.setItem(`revealed_${roomCode}`, 'true');
                        }
                    } else {
                        // ゲームが開始前（またはリセット後）なら演出フラグを消しておく
                        sessionStorage.removeItem(`revealed_${roomCode}`);
                    }
                });

                return () => unsubscribe();
            }, [roomCode, isJoined, myName, myUid]);

            // フェーズ変更時の入力リセット
            useEffect(() => {
                setHasActioned(false);
                setVoteConfirm(null);
                setQuestConfirm(null);
                setSelectedPlayers([]);
            }, [gameState?.phase, gameState?.voteCount, gameState?.currentQuest]);

            // 人数が変わった時に、デフォルトの役職セットを自動選択する
            useEffect(() => {
                if (gameState?.started) return;
                let roles = ['マーリン', 'パーシヴァル', '忠臣', '暗殺者', 'モルガナ'];
                if (pCount >= 6) roles.push('忠臣');
                if (pCount >= 7) roles.push('モードレッド');
                if (pCount >= 8) roles.push('忠臣');
                if (pCount >= 9) roles.push('忠臣');
                if (pCount >= 10) roles.push('オベロン');
                setSelectedRoles(roles);
            }, [pCount, gameState?.started]);

            // 【重要】ホストの編集内容をリアルタイムでFirebaseへ送信する
            useEffect(() => {
                // ホストであり、まだゲーム開始前で、かつ入室済みの場合のみ同期
                if (isHost && !gameState?.started && isJoined) {
                    window.fb.update(window.fb.ref(window.fb.db, `rooms/${roomCode}`), {
                        gameConfig: gameConfig,
                        selectedRoles: selectedRoles
                    });
                }
            }, [gameConfig, selectedRoles, isHost]); // 設定が変わるたびに実行

            // タイマー開始（ホストのみ実行）
            const startDiscussionTimer = (seconds) => {
                if (!isHost) return;
                const endTime = Date.now() + (seconds * 1000);
                dbUpdate({ discussionEndTime: endTime });
            };

            // タイマー停止（ホストのみ実行）
            const stopDiscussionTimer = () => {
                if (!isHost) return;
                dbUpdate({ discussionEndTime: null });
            };

            // タイマーのカウントダウン
            useEffect(() => {
                const timer = setInterval(() => {
                    if (gameState?.discussionEndTime) {
                        const remaining = Math.max(0, Math.floor((gameState.discussionEndTime - Date.now()) / 1000));
                        setTimeLeft(remaining);
                    } else {
                        setTimeLeft(null);
                    }
                }, 500);
                return () => clearInterval(timer);
            }, [gameState?.discussionEndTime]);



            // ゲーム開始を検知して、全員一斉に役職演出を開始する
            useEffect(() => {
                if (!gameState) return;

                // 「ゲーム開始状態」かつ「このセッションでまだ演出を見ていない」場合のみ
                const alreadyRevealed = sessionStorage.getItem(`revealed_${roomCode}`);

                if (gameState.started && !alreadyRevealed) {
                    setIsRevealingRole(true);
                    // ★重要：表示が始まった瞬間にフラグを立ててしまう
                    sessionStorage.setItem(`revealed_${roomCode}`, 'true');
                }

                // ゲームがリセットされたら、フラグも削除して次のゲームに備える
                if (!gameState.started) {
                    sessionStorage.removeItem(`revealed_${roomCode}`);
                }
            }, [gameState?.started, roomCode]);

            // 演出同期: 投票結果のカットイン
            useEffect(() => {
                if (gameState?.lastVoteId && gameState?.lastVoteStatus) {
                    setLastVoteStatus(gameState.lastVoteStatus);
                    setIsRevealingVote(true);
                    const timer = setTimeout(() => setIsRevealingVote(false), 2500);
                    return () => clearTimeout(timer);
                }
            }, [gameState?.lastVoteId]);

            // 演出同期: クエストカードめくり
            useEffect(() => {
                if (gameState?.tempResults && !revealing && !gameState?.isQuestPerforming) {
                    startRevealSequence(gameState.tempResults);
                }
            }, [gameState?.tempResults, gameState?.isQuestPerforming]);

            // 演出同期: マッチポイント激アツカットイン
            useEffect(() => {
                setIsMatchPointPerforming(!!gameState?.isQuestPerforming);
            }, [gameState?.isQuestPerforming]);

            // 演出同期: 暗殺フェーズ
            useEffect(() => {
                if (gameState?.phase === 'assassination') {
                    setIsRevealingAssassination(true);
                    setTimeout(() => setIsRevealingAssassination(false), 3000);
                }
                setIsAssassinating(!!gameState?.isAssassinationPerforming);
            }, [gameState?.phase, gameState?.isAssassinationPerforming]);

            // --- 5. アクション関数 ---
            const joinGame = async () => {
                if (!roomCode || !myName) return alert("部屋コードと名前を入力してください");

                const roomRef = window.fb.ref(window.fb.db, `rooms/${roomCode}`);
                const playerRef = window.fb.ref(window.fb.db, `rooms/${roomCode}/players/${myName}`);

                try {
                    // 1. 最新のプレイヤーデータを取得して検問
                    const snapshot = await window.fb.get(playerRef);
                    const playerData = snapshot.val();

                    // 2. 他のブラウザ（別UID）が既にその名前を使っている場合
                    if (playerData && playerData.uid && playerData.uid !== myUid) {
                        alert("汝は偽物なり。その名は既に別の騎士によって封印されている。");
                        return; // ここで完全に終了し、画面は切り替えない
                    }

                    // 3. 部屋の状態を確認
                    const roomSnapshot = await window.fb.get(roomRef);
                    const roomData = roomSnapshot.val();

                    // 4. 書き込みデータ作成
                    const updates = {};
                    updates[`players/${myName}/joined`] = true;
                    updates[`players/${myName}/uid`] = myUid;

                    if (!roomData || !roomData.host) {
                        updates.host = myName;
                        updates.hostUid = myUid;
                    }
                    updates.lastActivity = Date.now();

                    // 5. 【最重要】Firebaseへの書き込みが完了したことを「待つ」
                    await window.fb.update(roomRef, updates);

                    // 6. 書き込みが成功したことが確認できてから、初めて入室を許可する
                    localStorage.setItem('avalon_room', roomCode);
                    localStorage.setItem('avalon_name', myName);
                    setIsJoined(true);

                } catch (error) {
                    console.error("検問エラー:", error);
                    alert("通信エラーが発生しました。");
                }
            };

            const confirmSettings = () => {
                // 人数チェック
                if (selectedRoles.length !== pCount) {
                    return alert(`【天命の不一致】\n現在の参加人数は ${pCount} 名ですが、役職が ${selectedRoles.length} 名分です。構成を見直してください。`);
                }
                // モーダルを開く
                setShowStartConfirm(true);
            };

            const kickPlayer = (targetName) => {
                if (!isHost || targetName === myName) return; // 自分自身はキック不可
                if (window.confirm(`${targetName} を遠征軍から除外しますか？`)) {
                    // Firebaseから特定のプレイヤーを削除
                    window.fb.remove(window.fb.ref(window.fb.db, `rooms/${roomCode}/players/${targetName}`));
                    addLog(`${targetName} がホストによって除外されました`);
                }
            };

            const startGame = () => {
                const players = Object.keys(gameState.players);
                // 人数と選択された役職数が一致しているかチェック
                if (players.length !== selectedRoles.length) {
                    return alert(`人数(${players.length})と役職数(${selectedRoles.length})が一致しません`);
                }

                // シャッフル
                const shuffledPlayers = [...players].sort(() => Math.random() - 0.5);
                const shuffledRoles = [...selectedRoles].sort(() => Math.random() - 0.5);

                const playerMap = {};
                shuffledPlayers.forEach((name, i) => {
                    playerMap[name] = shuffledRoles[i]; // ここで全員分をマッピング
                });

                dbUpdate({
                    started: true,
                    phase: 'propose',
                    playerMap: playerMap, // 全員の役職データをDBに保存
                    playerList: shuffledPlayers, // プレイ順も保存
                    currentLeader: shuffledPlayers[0],
                    currentQuest: 1,
                    questResults: [],
                    voteCount: 0,
                    logs: addLog("聖戦の幕が上がった。運命を受け入れよ。")
                });

                // ホスト自身の画面でも演出を開始
                setIsRevealingRole(true);
            };

            const proposeTeam = () => {
                dbUpdate({
                    phase: 'voting',
                    proposedTeam: selectedPlayers,
                    votes: {},
                    logs: addLog(`${myName}が遠征メンバーを提案: ${selectedPlayers.join(", ")}`)
                });
            };

            // 1. トランザクションを利用した投票関数
            const castVote = (choice) => {
                const registeredUid = gameState.players[myName]?.uid;

                if (registeredUid !== myUid) {
                    alert("汝は偽物なり。真の騎士のみが行動を許される。");
                    return;
                }
                if (hasActioned) return;
                setHasActioned(true);

                // 投票データが保存されているパスを指定
                const votesRef = window.fb.ref(window.fb.db, `rooms/${roomCode}/votes`);

                // 順番待ちをさせて確実に1票ずつ追加する
                window.fb.runTransaction(votesRef, (currentVotes) => {
                    // 現在の投票データに自分の票を加えた新しいオブジェクトを返す
                    return { ...(currentVotes || {}), [myName]: choice };
                }).then(() => {
                    // 書き込み成功後、全員揃ったかチェックする
                    checkVoteEnd();
                }).catch((error) => {
                    console.error("投票トランザクションエラー:", error);
                    setHasActioned(false); // 失敗した場合は再試行を許可
                });
            };

            // 2. 全員が投票し終えたか確認し、フェーズを進める補助関数
            const checkVoteEnd = () => {
                const roomRef = window.fb.ref(window.fb.db, `rooms/${roomCode}`);

                // 最新のルームデータを取得して判定
                window.fb.get(roomRef).then((snapshot) => {
                    const data = snapshot.val();
                    if (!data) return;

                    const currentVotes = data.votes || {};
                    const playerList = data.playerList || [];

                    // 全員の票が揃った場合のみ集計処理を行う
                    if (Object.keys(currentVotes).length === playerList.length) {
                        const yesCount = Object.values(currentVotes).filter(v => v === 'yes').length;
                        const approved = yesCount > playerList.length / 2;
                        const voteDetails = Object.entries(currentVotes)
                            .map(([n, v]) => `${n}:${v === 'yes' ? '○' : '×'}`)
                            .join("  ");

                        const newVoteRecord = {
                            quest: data.currentQuest,
                            count: (data.voteCount || 0) + 1,
                            leader: data.currentLeader,
                            team: [...data.proposedTeam],
                            details: voteDetails,
                            approved
                        };

                        const baseUpdate = {
                            votes: {}, // 次の投票のために空にする
                            lastVoteStatus: approved ? 'approved' : 'rejected',
                            lastVoteId: Date.now(),
                            lastVoteResult: voteDetails,
                            voteHistory: [...(data.voteHistory || []), newVoteRecord]
                        };

                        if (approved) {
                            // 承認時：クエストフェーズへ
                            dbUpdate({
                                ...baseUpdate,
                                phase: 'quest',
                                questData: {},
                                logs: addLog(`提案承認 (${yesCount}票)。`)
                            });
                        } else {
                            // 却下時：リーダー交代または5回却下で終了
                            const nextIdx = (playerList.indexOf(data.currentLeader) + 1) % playerList.length;
                            const newCount = (data.voteCount || 0) + 1;
                            dbUpdate({
                                ...baseUpdate,
                                phase: newCount >= 5 ? 'end' : 'propose',
                                winner: newCount >= 5 ? 'EVIL' : null,
                                currentLeader: playerList[nextIdx],
                                voteCount: newCount >= 5 ? 0 : newCount,
                                logs: addLog(newCount >= 5 ? "5回却下により邪悪の勝利" : `提案却下。`)
                            });
                        }
                    }
                });
            };

            const questAction = (choice) => {
                const registeredUid = gameState.players[myName]?.uid;
                if (registeredUid !== myUid) {
                    alert("汝は偽物なり。真の騎士のみが運命を選択できる。");
                    return;
                }

                if (hasActioned) return;
                setHasActioned(true);
                dbUpdate({ lastVoteId: null, lastVoteStatus: null });

                const myRole = gameState.playerMap[myName];
                const isEvil = ['暗殺者', 'モルガナ', 'モードレッド', 'オベロン'].includes(myRole);
                const finalChoice = isEvil ? choice : 'success';

                const newData = { ...(gameState.questData || {}), [myName]: finalChoice };
                const team = gameState.proposedTeam;

                if (Object.keys(newData).length === team.length) {
                    const shuffledResults = Object.values(newData).sort(() => Math.random() - 0.5);
                    const goodWins = (gameState.questResults || []).filter(r => r === 'success').length;
                    const evilWins = (gameState.questResults || []).filter(r => r === 'fail').length;
                    const isMatchPoint = (goodWins === 2 || evilWins === 2);

                    if (isMatchPoint) {
                        dbUpdate({ questData: newData, isQuestPerforming: true, questPerformingId: Date.now() });
                        setTimeout(() => {
                            dbUpdate({ isQuestPerforming: false, tempResults: shuffledResults });
                        }, 6000);
                    } else {
                        dbUpdate({ questData: newData, tempResults: shuffledResults });
                    }
                } else {
                    dbUpdate({ questData: newData });
                }
            };

            const startRevealSequence = (resultsArray) => {
                setRevealing(true);
                let currentShown = [];
                resultsArray.forEach((res, index) => {
                    setTimeout(() => {
                        currentShown.push(res);
                        setDisplayResults([...currentShown]);
                        if (currentShown.length === resultsArray.length) {
                            setTimeout(() => {
                                setRevealing(false);
                                setDisplayResults([]);
                                if (gameState.currentLeader === myName) finishQuestLogic(resultsArray);
                            }, 2000);
                        }
                    }, (index + 1) * 1000);
                });
            };

            const finishQuestLogic = (resultsArray) => {
                const config = gameState.gameConfig || DEFAULT_CONFIG;
                const failsRequired = config[pCount]?.failsRequired[gameState.currentQuest - 1] || 1;

                const fails = resultsArray.filter(v => v === 'fail').length;
                const success = fails < failsRequired;

                const newResults = [...(gameState.questResults || []), success ? 'success' : 'fail'];
                const nextLeaderIdx = (gameState.playerList.indexOf(gameState.currentLeader) + 1) % gameState.playerList.length;

                let nextPhase = 'propose';
                let winner = null;
                if (newResults.filter(r => r === 'fail').length >= 3) { winner = 'EVIL'; nextPhase = 'end'; }
                else if (newResults.filter(r => r === 'success').length >= 3) { nextPhase = 'assassination'; }

                dbUpdate({
                    phase: nextPhase,
                    winner,
                    currentQuest: nextPhase === 'propose' ? gameState.currentQuest + 1 : gameState.currentQuest,
                    currentLeader: gameState.playerList[nextLeaderIdx],
                    questResults: newResults,
                    questHistory: [...(gameState.questHistory || []), {
                        team: [...gameState.proposedTeam],
                        result: success ? 'success' : 'fail',
                        details: resultsArray.map(r => r === 'success' ? '○' : '×').join(" ")
                    }],
                    tempResults: null,
                    questData: {},
                    voteCount: 0,
                    logs: addLog(`第${gameState.currentQuest}遠征結果: ${success ? "成功" : "失敗"}`)
                });
            };

            const executeAssassination = (targetName) => {
                // 【UID認証】自分が本当に暗殺者として登録されているか、UIDで最終確認
                const registeredUid = gameState.players[myName]?.uid;
                if (registeredUid !== myUid) {
                    alert("汝に暗殺の権限はない。");
                    return;
                }

                const isMerlin = gameState.playerMap[targetName] === 'マーリン';
                dbUpdate({ assassinationTarget: targetName, isAssassinationPerforming: true, assassinationId: Date.now() });
                setTimeout(() => {
                    dbUpdate({
                        phase: 'end',
                        winner: isMerlin ? 'EVIL' : 'GOOD',
                        assassinationResult: isMerlin ? 'success' : 'fail',
                        isAssassinationPerforming: false,
                        logs: addLog(isMerlin ? `暗殺成功！` : `暗殺失敗！`)
                    });
                }, 5000);
            };

            // 前回の started 状態を記憶するための参照（初期値は true にしておくことでリロード時の発火を防ぐ）
            const prevStartedRef = React.useRef(false);

            // ゲーム開始を検知して、全員一斉に役職演出を開始する
            useEffect(() => {
                // 1. まだデータがない、あるいはゲームが始まっていない場合は何もしない
                if (!gameState) return;

                if (!gameState.started) {
                    // ゲームがリセット状態なら、フラグをすべてクリアして次戦に備える
                    prevStartedRef.current = false;
                    sessionStorage.removeItem(`revealed_${roomCode}`);
                    return;
                }

                // 2. 「未視聴」かつ「開始フラグが今 true になった」場合のみ演出を実行
                const alreadyRevealed = sessionStorage.getItem(`revealed_${roomCode}`);

                // started が false -> true になった瞬間を検知
                if (gameState.started && prevStartedRef.current === false && !alreadyRevealed) {
                    setIsRevealingRole(true);
                    // sessionStorageに即座に記録（リロード対策）
                    sessionStorage.setItem(`revealed_${roomCode}`, 'true');
                }

                // 3. 現在の状態を ref に保存（次回の比較用）
                prevStartedRef.current = !!gameState.started;
            }, [gameState?.started, roomCode]);

            const handleReset = () => {
                if (confirm("ゲームを完全にリセットしますか？")) {
                    sessionStorage.removeItem(`revealed_${roomCode}`);
                    setShowEndResult(true);
                    window.fb.remove(window.fb.ref(window.fb.db, `rooms/${roomCode}`));
                    location.reload();
                }
            };

            // --- 6. 情報表示用 (メモ化) ---
            const seenInfo = useMemo(() => {
                if (!gameState?.playerMap) return [];
                const myRole = gameState.playerMap[myName];
                const info = [];
                Object.entries(gameState.playerMap).forEach(([name, role]) => {
                    if (name === myName) return;
                    if (myRole === 'マーリン' && ['暗殺者', 'モルガナ', 'オベロン'].includes(role)) info.push(`${name}: 邪悪`);
                    if (myRole === 'パーシヴァル' && ['マーリン', 'モルガナ'].includes(role)) info.push(`${name}: マーリン候補`);
                    if (['暗殺者', 'モルガナ', 'モードレッド'].includes(myRole) && ['暗殺者', 'モルガナ', 'モードレッド'].includes(role)) info.push(`${name}: 仲間`);
                });
                return info;
            }, [gameState?.playerMap, myName]);


            if (!isJoined) return (
                <div className="flex flex-col items-center justify-center h-screen space-y-8 fade-in">
                    <h1 className="text-6xl font-cinzel gold-text tracking-widest drop-shadow-lg">AVALON</h1>
                    <div className="bg-dark-card p-8 rounded-lg gold-border w-80 space-y-4 shadow-2xl">
                        <input className="w-full bg-black border border-gray-700 p-3 rounded" placeholder="ROOM CODE" value={roomCode} onChange={e => setRoomCode(e.target.value)} />
                        <input className="w-full bg-black border border-gray-700 p-3 rounded" placeholder="YOUR NAME" value={myName} onChange={e => setMyName(e.target.value)} />
                        <button onClick={joinGame} className="w-full btn-gold py-3 rounded hover:brightness-125 transition-all">ENTER GAME</button>
                    </div>
                </div>
            );


            return (
                <div className="max-w-md mx-auto p-4 space-y-4 fade-in">
                    <header className="flex justify-between items-end border-b-2 border-[#c5a059]/50 pb-3 mb-6">
                        <div className="flex flex-col">
                            {/* サブタイトル：現在のルームを表示 */}
                            <span className="text-[10px] text-[#c5a059]/60 tracking-[0.2em] font-bold uppercase mb-1">
                                Chamber: {roomCode || "Unknown"}
                            </span>
                            {/* メインタイトル：Cinzelフォントの重厚感を強調 */}
                            <div className="flex items-center gap-2">
                                <span className="text-xl font-cinzel gold-text tracking-widest leading-none">
                                    AVALON
                                </span>
                                <span className="text-[10px] bg-[#c5a059]/10 text-[#c5a059] border border-[#c5a059]/30 px-1.5 py-0.5 rounded leading-none font-bold">
                                    CMD
                                </span>
                            </div>
                        </div>

                        {/* 操作系：RESETボタンを少し上品に */}
                        <div className="flex items-center gap-4">
                            <button
                                onClick={handleReset}
                                className="group flex flex-col items-end gap-1 transition-all"
                            >
                                <span className="text-[9px] text-red-500/50 group-hover:text-red-500 uppercase tracking-tighter transition-colors">
                                    Term. Session
                                </span>
                                <div className="px-3 py-1 border border-red-900/50 group-hover:border-red-600 rounded-sm bg-red-900/10 group-hover:bg-red-900/30 text-[10px] text-red-500 font-bold transition-all">
                                    RESET
                                </div>
                            </button>
                        </div>
                    </header>

                    {!gameState?.started ? (
                        <div className="bg-dark-card p-8 rounded-lg gold-border shadow-2xl space-y-8 animate-fadeIn">
                            {/* ヘッダー：招集の合図 */}
                            <div className="text-center space-y-2">
                                <h2 className="font-cinzel gold-text text-xl tracking-[0.3em]">Gathering of Knights</h2>
                                <div className="flex justify-center items-center gap-2">
                                    <span className="h-[1px] w-8 bg-gold/30"></span>
                                    <p className="text-[10px] text-gold/60 uppercase tracking-widest font-bold">
                                        {gameState?.players ? Object.keys(gameState.players).length : 1} 名の騎士が集結
                                    </p>
                                    <span className="h-[1px] w-8 bg-gold/30"></span>
                                </div>
                            </div>

                            {/* 参加者リスト：円卓の名簿形式（垂直リスト） */}
                            <div className="py-2 space-y-2 max-w-xs mx-auto min-h-[160px]">
                                {gameState && gameState.players ? (
                                    Object.keys(gameState.players).map((name, idx) => (
                                        <div
                                            key={name}
                                            className={`flex items-center justify-between px-4 py-3 border-l-2 animate-fadeIn transition-all duration-500
    ${name === myName
                                                    ? 'bg-gold/10 border-gold shadow-[inset_4px_0_10px_rgba(197,160,89,0.1)]'
                                                    : 'bg-white/5 border-white/10 hover:bg-white/10'}`}
                                            style={{ animationDelay: `${idx * 0.1}s` }}
                                        >
                                            <div className="flex items-center gap-3">
                                                <div className={`w-1.5 h-1.5 rotate-45 ${name === myName ? 'bg-gold animate-pulse' : 'bg-gold/30'}`}></div>
                                                <span className={`text-sm tracking-widest font-bold ${name === myName ? 'text-gold' : 'text-gray-300'}`}>
                                                    {name}
                                                </span>
                                                {/* --- ホスト識別用の王冠マーク (SVG) --- */}
                                                {name === gameState?.host && (
                                                    <span className="ml-1 flex items-center justify-center" title="ホスト（聖域の守護者）">
                                                        <svg className="w-3.5 h-3.5 text-gold drop-shadow-[0_0_3px_rgba(197,160,89,0.6)]" viewBox="0 0 24 24" fill="currentColor">
                                                            <path d="M5,16L3,5L8.5,10L12,4L15.5,10L21,5L19,16H5M19,19C19,19.6 18.6,20 18,20H6C5.4,20 5,19.6 5,19V18H19V19Z" />
                                                        </svg>
                                                    </span>
                                                )}
                                            </div>

                                            <div className="flex items-center gap-3">
                                                {/* ホスト権限：自分以外のプレイヤーに「除外」ボタンを表示 */}
                                                {isHost && name !== myName && (
                                                    <button
                                                        onClick={() => kickPlayer(name)}
                                                        className="text-[7px] border border-red-900/50 px-1.5 py-0.5 rounded bg-red-950/20 text-red-500 hover:bg-red-600 hover:text-white transition-all uppercase font-bold tracking-tighter"
                                                    >
                                                        Kick
                                                    </button>
                                                )}

                                                {name === myName ? (
                                                    <span className="text-[8px] font-cinzel text-gold border border-gold/30 px-1.5 py-0.5 rounded-sm tracking-widest">
                                                        YOU
                                                    </span>
                                                ) : (
                                                    <span className="text-[8px] font-cinzel text-gray-600 tracking-widest uppercase font-bold">
                                                        Knight
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                    ))

                                ) : (
                                    <div className="text-center py-10">
                                        <p className="text-xs italic text-gold/40 animate-pulse tracking-[0.2em]">
                                            Waiting for companions to arrive...
                                        </p>
                                    </div>
                                )}
                                {/* 聖戦のレギュレーション設定エリア */}
                                <div className="bg-black/40 p-5 rounded border border-white/10 my-6 shadow-2xl animate-fadeIn relative overflow-hidden">
                                    {isHost ? (
                                        /* --- ホスト専用：戦局編制画面 --- */
                                        <div className="space-y-8">
                                            {/* ヘッダー */}
                                            <div className="flex justify-between items-center border-b border-white/5 pb-2">
                                                <div className="flex items-center gap-2">
                                                    <div className="w-1.5 h-1.5 rotate-45 bg-gold animate-pulse"></div>
                                                    <h3 className="text-gold font-cinzel text-[10px] tracking-widest uppercase font-bold text-shadow-sm">Divine Command Center</h3>
                                                </div>
                                                <span className="text-[7px] text-gold font-bold tracking-tighter px-2 py-0.5 bg-gold/10 border border-gold/20 rounded uppercase">
                                                    Host Authority
                                                </span>
                                            </div>

                                            {/* 1. 遠征人数と失敗条件 */}
                                            <div className="space-y-4">
                                                <div className="flex justify-between items-end">
                                                    <p className="text-[9px] text-white/50 uppercase font-black tracking-widest italic">1. Deployment Scale <span className="text-white/20 ml-1">― 遠征規模</span></p>
                                                    <span className="text-[8px] text-gold/60 font-bold">{pCount}名による聖戦</span>
                                                </div>

                                                <div className="grid grid-cols-5 gap-2">
                                                    {(gameState?.gameConfig?.[pCount] || gameConfig[pCount] || DEFAULT_CONFIG[5]).members.map((num, idx) => (
                                                        <div key={idx} className="flex flex-col items-center gap-1 group">
                                                            <span className="text-[7px] text-gray-600 font-bold italic mb-1">Q{idx + 1}</span>

                                                            {/* 増加ボタン：黄金の尖塔 */}
                                                            <button
                                                                onClick={() => adjustMemberCount(idx, 1)}
                                                                className="text-[10px] gold-text hover:scale-125 hover:drop-shadow-[0_0_8px_#c5a059] transition-all duration-300 leading-none pb-1"
                                                            >
                                                                ▲
                                                            </button>

                                                            {/* 人数表示枠 */}
                                                            <div className="w-full bg-white/5 border border-white/10 text-[12px] font-black text-center text-gold py-1 rounded-sm shadow-inner">
                                                                {num}
                                                            </div>

                                                            {/* 減少ボタン：逆転の尖塔 */}
                                                            <button
                                                                onClick={() => adjustMemberCount(idx, -1)}
                                                                className="text-[10px] gold-text hover:scale-125 hover:drop-shadow-[0_0_8px_#c5a059] transition-all duration-300 leading-none pt-1"
                                                            >
                                                                ▼
                                                            </button>

                                                            {/* 失敗枚数トグル（既存） */}
                                                            <button
                                                                onClick={() => {
                                                                    const currentConf = gameState?.gameConfig || gameConfig;
                                                                    const newConfig = JSON.parse(JSON.stringify(currentConf));
                                                                    const currentFails = newConfig[pCount].failsRequired[idx];
                                                                    newConfig[pCount].failsRequired[idx] = currentFails === 1 ? 2 : 1;
                                                                    setGameConfig(newConfig);
                                                                }}
                                                                className={`text-[7px] w-full py-1 mt-1 rounded-sm border font-black transition-all ${(gameState?.gameConfig?.[pCount] || gameConfig[pCount])?.failsRequired[idx] >= 2
                                                                    ? 'bg-red-900/40 border-red-500 text-red-100'
                                                                    : 'bg-blue-900/10 border-blue-900/40 text-blue-400 opacity-60'
                                                                    }`}
                                                            >
                                                                {(gameState?.gameConfig?.[pCount] || gameConfig[pCount])?.failsRequired[idx]} FAIL
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>

                                            {/* 2. 役職の選定 (スロット形式) */}
                                            <div className="space-y-4 pt-4 border-t border-white/5">
                                                <div className="flex justify-between items-end">
                                                    <p className="text-[9px] text-white/50 uppercase font-black tracking-widest italic">2. Roles Assignment <span className="text-white/20 ml-1">― 役職構成</span></p>
                                                    <span className={`text-[9px] font-bold transition-colors ${selectedRoles.length === pCount ? 'text-green-500' : 'text-red-500 animate-pulse'}`}>
                                                        {selectedRoles.length} / {pCount} 名 確定
                                                    </span>
                                                </div>

                                                <div className="space-y-3">
                                                    {/* 固定枠 */}
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <div className="px-3 py-2 bg-blue-900/10 border border-blue-500/20 rounded flex justify-between items-center">
                                                            <span className="text-[11px] font-bold text-blue-400">マーリン</span>
                                                            <span className="text-[7px] text-blue-500/50 uppercase font-black tracking-tighter">Fixed 1</span>
                                                        </div>
                                                        <div className="px-3 py-2 bg-red-900/10 border border-red-500/20 rounded flex justify-between items-center">
                                                            <span className="text-[11px] font-bold text-red-500">暗殺者</span>
                                                            <span className="text-[7px] text-red-500/50 uppercase font-black tracking-tighter">Fixed 1</span>
                                                        </div>
                                                    </div>

                                                    {/* 特殊役職：上限リミッター付き */}
                                                    <div className="flex flex-wrap gap-2">
                                                        {['パーシヴァル', 'モルガナ', 'モードレッド', 'オベロン'].map(role => {
                                                            const isSelected = selectedRoles.includes(role);
                                                            return (
                                                                <button
                                                                    key={role}
                                                                    onClick={() => {
                                                                        if (!isSelected && selectedRoles.length >= pCount) return; // 人数上限
                                                                        setSelectedRoles(prev => isSelected ? prev.filter(r => r !== role) : [...prev, role]);
                                                                    }}
                                                                    className={`px-3 py-2 text-[10px] font-bold rounded border transition-all ${isSelected ? 'border-gold bg-gold/20 text-gold shadow-lg' : 'border-white/5 bg-black/40 text-gray-600 opacity-40'
                                                                        }`}
                                                                >
                                                                    {role}
                                                                </button>
                                                            );
                                                        })}
                                                    </div>

                                                    {/* 忠臣カウンター：増加リミッター付き */}
                                                    <div className="p-3 bg-black/60 border border-white/5 rounded-sm flex justify-between items-center">
                                                        <div className="flex flex-col"><span className="text-[10px] text-gray-300 font-bold">アーサー王の忠臣</span><span className="text-[7px] text-gray-600 font-bold tracking-tighter">Loyal Servant</span></div>
                                                        <div className="flex items-center gap-4 bg-white/5 px-2 py-1 rounded">
                                                            <button
                                                                onClick={() => {
                                                                    const idx = selectedRoles.lastIndexOf('忠臣');
                                                                    if (idx !== -1) {
                                                                        const next = [...selectedRoles]; next.splice(idx, 1); setSelectedRoles(next);
                                                                    }
                                                                }}
                                                                className={`w-6 h-6 flex items-center justify-center transition-colors ${selectedRoles.filter(r => r === '忠臣').length > 0 ? 'text-white' : 'text-gray-800 pointer-events-none'}`}
                                                            >―</button>
                                                            <span className="text-xs font-cinzel text-gold font-bold w-4 text-center">{selectedRoles.filter(r => r === '忠臣').length}</span>
                                                            <button
                                                                onClick={() => {
                                                                    if (selectedRoles.length < pCount) setSelectedRoles(prev => [...prev, '忠臣']);
                                                                }}
                                                                className={`w-6 h-6 flex items-center justify-center transition-colors ${selectedRoles.length < pCount ? 'text-white' : 'text-gray-800 pointer-events-none'}`}
                                                            >＋</button>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* 警告表示 */}
                                                {selectedRoles.length !== pCount && (
                                                    <div className="bg-red-950/20 border-l-2 border-red-600 p-2 animate-fadeIn">
                                                        <p className="text-[8px] text-red-400 font-bold leading-tight">
                                                            ※聖戦の封印が解けません。役職の合計を現在の人数（{pCount}名）に調整してください。
                                                        </p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ) : (
                                        /* --- ゲスト専用：静寂の待機（DB同期プレビュー付き） --- */
                                        <div className="py-12 flex flex-col items-center justify-center space-y-8 animate-fadeIn">
                                            {/* 中央のシンボル：静かな点滅演出 */}
                                            <div className="relative">
                                                <div className="w-12 h-12 border border-gold/10 rotate-45 flex items-center justify-center">
                                                    <div className="w-8 h-8 border border-gold/20 rotate-45"></div>
                                                </div>
                                                <div className="absolute inset-0 flex items-center justify-center">
                                                    <div className="w-2 h-2 bg-gold rotate-45 animate-pulse shadow-[0_0_10px_rgba(197,160,89,1)]"></div>
                                                </div>
                                            </div>

                                            <div className="text-center space-y-2">
                                                <h3 className="text-gold font-cinzel text-xs tracking-[0.4em] font-black uppercase">Receiving Decree</h3>
                                                <p className="text-[9px] text-white/40 font-bold tracking-[0.2em]">
                                                    ホストが聖戦の盟約（レギュレーション）を編制中...
                                                </p>
                                            </div>

                                            {/* 同期結果のプレビューエリア（gameStateを参照） */}
                                            <div className="w-full max-w-[280px] bg-black/20 border border-white/5 rounded-sm p-4 space-y-4 shadow-inner">
                                                <div className="space-y-2">
                                                    <div className="flex justify-between items-center px-1">
                                                        <span className="text-[7px] text-gray-500 uppercase font-black tracking-widest italic">Formation Sync</span>
                                                        <span className="text-[8px] text-gold/60 font-bold">{pCount} Knights</span>
                                                    </div>
                                                    <div className="flex justify-between gap-1">
                                                        {/* DEFAULT_CONFIGをフォールバックにしつつ、DBの設定を表示 */}
                                                        {((gameState?.gameConfig || DEFAULT_CONFIG)[pCount])?.members.map((num, idx) => (
                                                            <div key={idx} className="flex-1 flex flex-col items-center gap-1">
                                                                <div className="w-full py-1 bg-white/5 border border-white/10 rounded-sm text-[10px] font-black text-center text-gray-400">
                                                                    {num}
                                                                </div>
                                                                {/* 失敗枚数設定の同期点灯 */}
                                                                <div className={`w-1 h-1 rounded-full transition-all duration-500 ${((gameState?.gameConfig || DEFAULT_CONFIG)[pCount])?.failsRequired[idx] >= 2
                                                                    ? 'bg-red-600 shadow-[0_0_5px_rgba(220,38,38,0.8)]'
                                                                    : 'bg-blue-500/30'
                                                                    }`}></div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>

                                                <div className="pt-3 border-t border-white/5 flex flex-col items-center gap-2">
                                                    <span className="text-[7px] text-gray-500 uppercase font-black tracking-widest italic">Divine Roles Alignment</span>
                                                    <div className="flex flex-wrap justify-center gap-1.5 opacity-70 scale-90">
                                                        {/* ホストが選んでいる役職をリアルタイム表示 */}
                                                        {(gameState?.selectedRoles || []).map((role, idx) => (
                                                            <div key={idx} className={`px-1.5 py-0.5 border text-[7px] font-bold rounded-px animate-fadeIn ${['マーリン', 'パーシヴァル', '忠臣'].includes(role)
                                                                ? 'border-blue-900/50 text-blue-400/80 bg-blue-900/10'
                                                                : 'border-red-900/50 text-red-400/80 bg-red-900/10'
                                                                }`}>
                                                                {role}
                                                            </div>
                                                        ))}
                                                        {(gameState?.selectedRoles || []).length === 0 && <span className="text-[7px] text-gray-700 italic">No roles assigned yet</span>}
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="pt-4 border-t border-white/5 w-24 opacity-20"></div>
                                        </div>
                                    )}

                                    {/* 画面装飾 */}
                                    <div className="absolute top-0 left-0 w-full h-[1px] bg-gradient-to-r from-transparent via-gold/10 to-transparent animate-scanline"></div>
                                </div>
                            </div>

                            {/* 確定・開始ボタンエリア */}
                            <div className="pt-4 border-t border-white/10 space-y-3">
                                {isHost ? (
                                    /* リーダー（ホスト）用：聖戦開始ボタン */
                                    <button
                                        onClick={confirmSettings}
                                        className="w-full group relative py-4 bg-blue-700/20 border border-blue-500/40 text-blue-200 text-[11px] font-black tracking-[0.4em] uppercase hover:bg-blue-600/40 hover:text-white transition-all rounded shadow-[0_0_20px_rgba(59,130,246,0.2)] active:scale-95"
                                    >
                                        <div className="absolute inset-0 bg-blue-400/5 animate-pulse"></div>
                                        <span className="relative z-10">盟約を締結し、聖戦を開始する</span>
                                    </button>
                                ) : (
                                    /* ゲスト（一般参加者）用：非活性表示 */
                                    <div className="w-full py-4 bg-white/5 border border-white/5 text-gray-600 text-[11px] font-black tracking-[0.4em] uppercase rounded flex flex-col items-center justify-center space-y-1 opacity-60">
                                        <span>リーダーが盟約を編制中...</span>
                                        <span className="text-[7px] lowercase tracking-widest font-normal opacity-40 italic">Awaiting Leader's Decree</span>
                                    </div>
                                )}

                                {/* リーダーを待つメッセージ（ゲストのみ表示） */}
                                {!isHost && (
                                    <p className="text-[8px] text-center text-gray-700 mt-2 tracking-widest animate-pulse font-bold">
                                        ― リーダーによる天命の確定を待っています ―
                                    </p>
                                )}
                            </div>
                        </div>
                    ) : (
                        <div className="space-y-4">

                            {/* 1. 聖なる刻印（役職・特殊情報） */}
                            <div className={`bg-dark-card rounded-lg border-2 shadow-[0_0_20px_rgba(0,0,0,0.5)] overflow-hidden mb-4 transition-all duration-1000 ${['暗殺者', 'モルガナ', 'モードレッド', 'オベロン'].includes(gameState.playerMap?.[myName])
                                ? 'border-red-900/50 shadow-red-900/10'
                                : 'border-[#c5a059]/50 shadow-blue-900/10'
                                }`}>
                                <div className="p-4 flex justify-between items-center relative">
                                    {/* 背景の微かな紋章（装飾） */}
                                    <div className="absolute left-4 opacity-5 pointer-events-none">
                                        <span className="font-cinzel text-6xl">A</span>
                                    </div>

                                    <div className="relative z-10 space-y-1">
                                        <div className="flex items-center gap-2">
                                            <h3 className="text-[9px] uppercase text-gold/60 tracking-[0.2em] font-bold">Your Identity</h3>
                                            <span className="text-[8px] text-white/20">|</span>
                                            <span className="text-[9px] text-white/40 font-bold tracking-widest">汝の正体</span>
                                            <button
                                                onClick={() => setShowHelp(true)}
                                                className="ml-1 w-4 h-4 rounded-full border border-gold/40 text-[10px] flex items-center justify-center text-gold/60 hover:text-gold hover:border-gold hover:bg-gold/10 transition-all"
                                            >
                                                ?
                                            </button>
                                        </div>
                                        <p className="text-3xl font-cinzel text-white tracking-tighter drop-shadow-md">
                                            {gameState.playerMap?.[myName]}
                                        </p>
                                    </div>

                                    {/* 啓示された知識 (Knowledge) */}
                                    {seenInfo && seenInfo.length > 0 && (
                                        <div className="relative z-10 animate-fadeIn">
                                            <div className="bg-black/40 border-l-2 border-gold/50 pl-3 py-1 pr-2">
                                                <p className="text-[9px] text-gold font-bold uppercase tracking-[0.2em] mb-1 italic opacity-80">
                                                    Knowledge <span className="text-[8px] lowercase font-normal text-white/40 ml-1">― 啓示</span>
                                                </p>
                                                <div className="space-y-0.5">
                                                    {seenInfo.map((inf, idx) => (
                                                        <p key={idx} className="text-[10px] text-yellow-100/90 font-medium leading-tight">
                                                            {inf}
                                                        </p>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* カード下部の装飾ライン */}
                                <div className={`h-1 w-full opacity-30 ${['暗殺者', 'モルガナ', 'モードレッド', 'オベロン'].includes(gameState.playerMap?.[myName])
                                    ? 'bg-gradient-to-r from-transparent via-red-600 to-transparent'
                                    : 'bg-gradient-to-r from-transparent via-gold to-transparent'
                                    }`}></div>
                            </div>


                            {/* 2. 戦歴アーカイブへのアクセスボタン */}
                            <div className="flex gap-3 mb-6">
                                <button
                                    onClick={() => { setHistoryTab('quest'); setShowHistoryModal(true); }}
                                    className="group flex-1 relative overflow-hidden py-3 rounded-sm border border-red-900/40 bg-red-950/10 transition-all hover:bg-red-900/20 active:scale-[0.98]"
                                >
                                    {/* 装飾用：左端の垂直ライン */}
                                    <div className="absolute left-0 top-0 bottom-0 w-0.5 bg-red-600/50 group-hover:bg-red-500 transition-colors"></div>

                                    <div className="flex flex-col items-center">
                                        <span className="text-[10px] text-red-400 font-cinzel tracking-[0.3em] font-bold group-hover:text-red-300 transition-colors">
                                            QUEST LOGS
                                        </span>
                                        <span className="text-[8px] text-red-900 font-bold tracking-widest mt-0.5 uppercase opacity-60">
                                            遠征の記録
                                        </span>
                                    </div>
                                </button>

                                <button
                                    onClick={() => { setHistoryTab('vote'); setShowHistoryModal(true); }}
                                    className="group flex-1 relative overflow-hidden py-3 rounded-sm border border-blue-900/40 bg-blue-950/10 transition-all hover:bg-blue-900/20 active:scale-[0.98]"
                                >
                                    {/* 装飾用：左端の垂直ライン */}
                                    <div className="absolute left-0 top-0 bottom-0 w-0.5 bg-blue-600/50 group-hover:bg-blue-500 transition-colors"></div>

                                    <div className="flex flex-col items-center">
                                        <span className="text-[10px] text-blue-400 font-cinzel tracking-[0.3em] font-bold group-hover:text-blue-300 transition-colors">
                                            VOTE LOGS
                                        </span>
                                        <span className="text-[8px] text-blue-900 font-bold tracking-widest mt-0.5 uppercase opacity-60">
                                            評決の記録
                                        </span>
                                    </div>
                                </button>
                            </div>
                            {/* スコアボード */}
                            <div className="grid grid-cols-5 gap-2 mb-6">
                                {[1, 2, 3, 4, 5].map(i => {
                                    const result = gameState.questResults?.[i - 1];
                                    const isActive = gameState.currentQuest === i;

                                    // 【統合ポイント】DBの設定があれば優先、なければ現在の設定、それもなければデフォルトを参照
                                    const currentConf = gameState?.gameConfig?.[pCount] || gameConfig?.[pCount] || DEFAULT_CONFIG[pCount] || DEFAULT_CONFIG[5];

                                    // 人数と失敗必要枚数を設定から取得
                                    const numRequired = currentConf.members[i - 1];
                                    const failsRequired = currentConf.failsRequired[i - 1];

                                    // 【統合ポイント】設定値が「2」以上であればバッジを表示
                                    const isTwoFailsRequired = failsRequired >= 2;

                                    return (
                                        <div
                                            key={i}
                                            className={`relative h-16 flex flex-col items-center justify-center rounded-sm border-2 transition-all duration-500
                    ${result === 'success' ? 'bg-blue-900/20 border-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.2)]' :
                                                    result === 'fail' ? 'bg-red-900/20 border-red-500 shadow-[0_0_10px_rgba(239,68,68,0.2)]' :
                                                        'bg-black/40 border-gray-800'} 
                    ${isActive ? 'border-gold scale-105 z-10 shadow-[0_0_15px_rgba(197,160,89,0.3)]' : 'opacity-60'}`}
                                        >
                                            {/* クエスト番号 */}
                                            <span className={`text-[8px] font-bold tracking-tighter mb-1 ${isActive ? 'text-gold' : 'text-gray-500'}`}>
                                                QUEST 0{i}
                                            </span>

                                            {/* 必要人数 */}
                                            <div className="flex flex-col items-center leading-none">
                                                <span className="text-sm font-cinzel text-white">{numRequired}</span>
                                                <span className="text-[7px] text-white/40 uppercase tracking-tighter">Knights</span>
                                            </div>

                                            {/* 2失敗必要フラグ（動的判定） */}
                                            {isTwoFailsRequired && (
                                                <div className="absolute -top-1 -right-1">
                                                    <div className="bg-red-600 text-[7px] text-white px-1 py-0.5 rounded-full font-bold shadow-sm animate-pulse border border-red-400">
                                                        {failsRequired} FAIL
                                                    </div>
                                                </div>
                                            )}

                                            {/* 現在地インジケーター */}
                                            {isActive && (
                                                <div className="absolute -bottom-1.5 w-1 h-1 bg-gold rotate-45 shadow-[0_0_5px_rgba(197,160,89,1)]"></div>
                                            )}

                                            {/* 完了済みのサイン */}
                                            {result && (
                                                <div className={`absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none`}>
                                                    <span className="text-4xl font-bold">{result === 'success' ? 'V' : 'X'}</span>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>

                            {/* クエスト履歴リスト */}
                            {gameState.questHistory && gameState.questHistory.length > 0 && (
                                <div className="bg-black/60 rounded-lg border border-gray-800 overflow-hidden mb-4">
                                    <div className="bg-gray-900/50 px-3 py-1 border-b border-gray-800 flex justify-between items-center">
                                        <span className="text-[10px] text-gray-400 uppercase tracking-widest font-bold">Quest History</span>
                                        <span className="text-[9px] text-gray-500 italic">遠征の記録</span>
                                    </div>
                                    <div className="divide-y divide-gray-800">
                                        {gameState.questHistory.map((h, idx) => (
                                            <div key={idx} className="px-3 py-2 flex items-center justify-between animate-fadeIn">
                                                <div className="flex items-center gap-3">
                                                    <span className={`w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold ${h.result === 'success' ? 'bg-blue-900/50 text-blue-400 border border-blue-500/30' : 'bg-red-900/50 text-red-400 border border-red-500/30'}`}>
                                                        Q{idx + 1}
                                                    </span>
                                                    <div className="flex flex-wrap gap-1">
                                                        {h.team.map(member => (
                                                            <span key={member} className="text-[11px] bg-gray-800 px-1.5 py-0.5 rounded text-gray-300 border border-gray-700">
                                                                {member}
                                                            </span>
                                                        ))}
                                                    </div>
                                                </div>
                                                <span className={`text-[10px] font-bold ${h.result === 'success' ? 'text-blue-400' : 'text-red-400'}`}>
                                                    {h.result === 'success' ? 'SUCCESS' : 'FAIL'}
                                                </span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* 却下カウンターの表示 */}
                            <div className="flex justify-between items-center bg-black/40 p-2 rounded border border-red-900/30">
                                <span className="text-[10px] text-red-400 uppercase tracking-widest">投票失敗回数</span>
                                <div className="flex gap-1">
                                    {[1, 2, 3, 4, 5].map(i => (
                                        <div key={i} className={`w-3 h-3 rounded-full border ${gameState.voteCount >= i ? 'bg-red-600 border-red-400' : 'bg-gray-800 border-gray-600'}`}></div>
                                    ))}
                                </div>
                            </div>

                            {/* メンバー・投票状況エリア */}
                            <div className="bg-black/40 rounded-sm border border-white/5 mb-6 overflow-hidden">
                                {/* ヘッダーラベル */}
                                <div className="bg-white/5 px-3 py-1.5 flex justify-between items-center border-b border-white/5">
                                    <div className="flex items-center gap-2">
                                        <span className="w-1 h-1 bg-gold/50 rotate-45"></span>
                                        <span className="text-[9px] text-gray-400 uppercase tracking-[0.2em] font-bold font-cinzel">Alliance Roster</span>
                                    </div>
                                    {gameState.phase === 'voting' && (
                                        <span className="text-[8px] text-gold animate-pulse tracking-widest font-bold uppercase">
                                            Awaiting Decisions...
                                        </span>
                                    )}
                                </div>

                                {/* 討論用タイマーUI */}
                                <div className="bg-black/60 p-3 rounded border border-white/5 mb-4 flex items-center justify-between">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-2 h-2 rounded-full ${timeLeft > 0 ? 'bg-red-500 animate-pulse shadow-[0_0_8px_rgba(239,68,68,0.5)]' : 'bg-gray-600'}`}></div>
                                        <div className="flex flex-col">
                                            <span className="text-[9px] text-gray-500 uppercase font-black tracking-widest">Discussion Time</span>
                                            <span className="text-xl font-cinzel font-bold text-white tracking-widest">
                                                {timeLeft !== null
                                                    ? `${Math.floor(timeLeft / 60)}:${String(timeLeft % 60).padStart(2, '0')}`
                                                    : "--:--"}
                                            </span>
                                        </div>
                                    </div>

                                    {/* ホスト専用：タイマー操作パネル */}
                                    {isHost && (
                                        <div className="flex gap-2">
                                            {!gameState?.discussionEndTime ? (
                                                <>
                                                    <button onClick={() => startDiscussionTimer(60)} className="px-2 py-1 text-[8px] border border-gold/30 text-gold rounded hover:bg-gold/10 transition-all">1min</button>
                                                    <button onClick={() => startDiscussionTimer(180)} className="px-2 py-1 text-[8px] border border-gold/30 text-gold rounded hover:bg-gold/10 transition-all">3min</button>
                                                    <button onClick={() => startDiscussionTimer(300)} className="px-2 py-1 text-[8px] border border-gold/30 text-gold rounded hover:bg-gold/10 transition-all">5min</button>
                                                </>
                                            ) : (
                                                <button onClick={stopDiscussionTimer} className="px-3 py-1 text-[8px] border border-red-500/50 text-red-500 rounded bg-red-900/10 hover:bg-red-900/20 transition-all uppercase font-bold">Stop</button>
                                            )}
                                        </div>
                                    )}
                                </div>

                                {/* プレイヤーリスト */}
                                <div className="p-3 flex flex-wrap gap-2 justify-center">
                                    {gameState.playerList?.map(p => {
                                        const hasVoted = gameState.phase === 'voting' && gameState.votes && gameState.votes[p];
                                        const isMe = p === myName;
                                        const isLeader = p === gameState.currentLeader;

                                        return (
                                            <div
                                                key={p}
                                                className={`relative flex items-center gap-2 px-3 py-1.5 rounded-sm border transition-all duration-500 
                                                    ${isLeader
                                                        ? 'border-white border-2 shadow-[0_0_15px_rgba(255,255,255,0.2)] z-10 scale-105'
                                                        : 'border-white/10 bg-white/[0.02]'
                                                    } 
                                                    ${hasVoted
                                                        ? 'border-green-500/50 bg-green-500/10 opacity-100 shadow-[0_0_10px_rgba(34,197,94,0.1)]'
                                                        : gameState.phase === 'voting' ? 'opacity-40 grayscale' : 'opacity-80'
                                                    }`}
                                            >
                                                {/* リーダーアイコン：白いインジケーター */}
                                                {isLeader && (
                                                    <div className="flex flex-col items-center justify-center">
                                                        <div className="w-1.5 h-1.5 bg-white rotate-45 animate-pulse shadow-[0_0_8px_rgba(255,255,255,1)]"></div>
                                                    </div>
                                                )}

                                                {/* 名前：自分なら金色、それ以外はグレー */}
                                                <span className={`text-[11px] font-bold tracking-wider ${isMe ? 'text-gold brightness-125' : 'text-gray-300'}`}>
                                                    {p}
                                                </span>

                                                {/* 投票済みサイン */}
                                                {/* 投票済み：プルダウンに見えないよう、チェックマーク記号に変更 */}
                                                {hasVoted && (
                                                    <span className="ml-1 text-[12px] text-green-400 font-bold leading-none drop-shadow-[0_0_5px_rgba(74,222,128,0.5)]">
                                                        ✓
                                                    </span>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* メインアクションエリア */}
                            <div className="bg-dark-card p-5 rounded-lg border-l-4 border-[#c5a059] shadow-xl min-h-[160px] flex flex-col justify-center">
                                {gameState.phase === 'end' && !showEndResult && (
                                    <div className="mb-6 animate-fadeIn">
                                        <div className={`p-4 rounded-sm border-2 text-center mb-4 ${gameState.winner === 'GOOD' ? 'border-blue-500/30 bg-blue-900/10' : 'border-red-600/30 bg-red-900/10'
                                            }`}>
                                            <h4 className="text-sm font-bold text-white mb-1">
                                                {gameState.winner === 'GOOD' ? '【勝利】正義の軍勢' : '【勝利】邪悪な勢力'}
                                            </h4>
                                            <p className="text-[9px] text-gray-500 italic uppercase tracking-widest">The Battle has ended.</p>
                                        </div>

                                        <button
                                            onClick={() => setShowEndResult(true)}
                                            className="w-full py-3 bg-gold/10 border border-gold/40 text-gold text-[10px] font-bold tracking-widest uppercase hover:bg-gold/20 transition-all shadow-lg"
                                        >
                                            リザルト演出を再表示
                                        </button>
                                    </div>
                                )}
                                {gameState.phase === 'propose' && (
                                    <div className="space-y-5">
                                        <div className="text-center space-y-1">
                                            <p className="text-[10px] text-gold/60 uppercase tracking-[0.3em] font-bold font-cinzel">Formation Phase</p>
                                            <p className="text-sm font-bold text-gray-200">
                                                {gameState.currentLeader === myName
                                                    ? "汝はリーダーである。遠征隊を編成せよ。"
                                                    : `リーダー ${gameState.currentLeader} が選定中...`}
                                            </p>
                                        </div>

                                        {gameState.currentLeader === myName && (
                                            <div className="space-y-5 animate-fadeIn">
                                                <div className="flex flex-wrap gap-2 justify-center">
                                                    {gameState.playerList.map(p => {
                                                        const isSelected = selectedPlayers.includes(p);
                                                        return (
                                                            <button
                                                                key={p}
                                                                onClick={() => setSelectedPlayers(s => s.includes(p) ? s.filter(x => x !== p) : [...s, p])}
                                                                className={`px-4 py-1.5 text-xs rounded-sm border-2 transition-all duration-300 font-bold ${isSelected
                                                                    ? 'bg-blue-900/30 border-blue-400 text-blue-100 shadow-[0_0_10px_rgba(59,130,246,0.3)]'
                                                                    : 'bg-black border-white/10 text-gray-500 hover:border-white/30'
                                                                    }`}
                                                            >
                                                                {p}
                                                            </button>
                                                        );
                                                    })}
                                                </div>

                                                <button
                                                    disabled={selectedPlayers.length !== (gameState?.gameConfig || gameConfig || DEFAULT_CONFIG)[pCount]?.members[gameState.currentQuest - 1]}
                                                    onClick={proposeTeam}
                                                    className="w-full btn-gold py-3 rounded-sm text-[10px] tracking-[0.4em] uppercase font-black shadow-lg disabled:opacity-20 transition-all active:scale-[0.98]"
                                                >
                                                    編成案を提出する
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* 2. 投票フェーズ (voting) */}
                                {gameState.phase === 'voting' && (
                                    <div className="text-center space-y-6">
                                        <div className="inline-block px-5 py-1.5 bg-white/[0.03] border border-white/10 rounded-sm">
                                            <p className="text-[10px] text-gray-400 uppercase tracking-widest mb-1">Proposed Fellowship</p>
                                            <p className="text-sm text-gold font-bold tracking-widest">{gameState.proposedTeam.join(" , ")}</p>
                                        </div>

                                        {hasActioned ? (
                                            <div className="py-6 bg-white/[0.02] rounded-sm border border-white/5 animate-pulse">
                                                <p className="text-[10px] text-gold uppercase tracking-[0.3em] font-bold font-cinzel">Decision Archived</p>
                                                <p className="text-[9px] text-gray-500 mt-1">他の騎士たちの決断を待っています...</p>
                                            </div>
                                        ) : (
                                            <div className="flex flex-col gap-3">
                                                {!voteConfirm ? (
                                                    /* 承認・却下の初期選択 */
                                                    <div className="flex gap-4">
                                                        <button
                                                            onClick={() => setVoteConfirm('yes')}
                                                            className="flex-1 py-4 bg-green-950/20 border border-green-500/40 text-green-400 font-bold tracking-[0.2em] rounded-sm hover:bg-green-500/20 transition-all"
                                                        >
                                                            承 認
                                                        </button>
                                                        <button
                                                            onClick={() => setVoteConfirm('no')}
                                                            className="flex-1 py-4 bg-red-950/20 border border-red-500/40 text-red-400 font-bold tracking-[0.2em] rounded-sm hover:bg-red-500/20 transition-all"
                                                        >
                                                            却 下
                                                        </button>
                                                    </div>
                                                ) : (
                                                    /* 最終確認ステップ */
                                                    <div className="p-5 bg-black/60 border border-gold/40 rounded-sm space-y-4 animate-revealIdentity">
                                                        <p className="text-xs text-gold font-bold tracking-wider">
                                                            【最終確認】 本当に <span className={voteConfirm === 'yes' ? "text-green-400" : "text-red-500"}>
                                                                {voteConfirm === 'yes' ? '承認' : '却下'}
                                                            </span> しますか？
                                                        </p>
                                                        <div className="flex gap-2 w-full">
                                                            <button onClick={() => setVoteConfirm(null)} className="flex-1 py-2 bg-gray-800 text-[10px] text-gray-400 rounded-sm font-bold uppercase tracking-widest">キャンセル</button>
                                                            <button
                                                                onClick={() => castVote(voteConfirm)}
                                                                className={`flex-1 py-2 text-[10px] text-white font-bold rounded-sm uppercase tracking-widest ${voteConfirm === 'yes' ? 'bg-green-700 shadow-[0_0_15px_rgba(34,197,94,0.3)]' : 'bg-red-800 shadow-[0_0_15px_rgba(220,38,38,0.3)]'
                                                                    }`}
                                                            >
                                                                確定して送信
                                                            </button>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                )}

                                {gameState.phase === 'quest' && (
                                    <div className="text-center space-y-6 py-4">
                                        {/* --- 3番：結合ポイント（演出フラグで分岐） --- */}
                                        {revealing ? (
                                            /* 豪華なカードめくり演出画面 */
                                            <div className="fixed inset-0 z-[100] bg-black/95 flex flex-col items-center justify-center p-6 animate-fadeIn">
                                                <h2 className="font-cinzel text-xl gold-text mb-8 tracking-[0.3em] animate-pulse">REVEALING FATE</h2>

                                                <div className="flex gap-3 flex-wrap justify-center mb-8">
                                                    {/* 遠征メンバーの人数分だけカードを表示 */}
                                                    {Array.from({ length: gameState.proposedTeam.length }).map((_, i) => {
                                                        const res = displayResults[i]; // 演出用の1枚ずつの結果
                                                        return (
                                                            <div key={i} className={`w-16 h-24 border-2 flex items-center justify-center transition-all duration-500 transform shadow-lg
                                ${res ? (res === 'success' ? 'bg-blue-900 border-blue-400 rotate-0 scale-105' : 'bg-red-900 border-red-400 rotate-0 scale-105')
                                                                    : 'bg-gray-900 border-gray-700 rotate-12 scale-90 opacity-50'}`}>
                                                                {res && (
                                                                    <span className="text-3xl font-bold text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">
                                                                        {res === 'success' ? '○' : '×'}
                                                                    </span>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>

                                                {/* すべてめくり終わった時の最終判定セクション */}
                                                {displayResults.length === gameState.proposedTeam.length && (
                                                    <div className="text-center space-y-10 animate-revealIdentity pt-10 border-t border-white/5 w-full">
                                                        {(() => {
                                                            const fails = displayResults.filter(r => r === 'fail').length;

                                                            // 修正ポイント: 保存された設定を参照
                                                            const config = gameState.gameConfig || DEFAULT_CONFIG;
                                                            const pCount = gameState.playerList.length;
                                                            const failsRequired = config[pCount]?.failsRequired[gameState.currentQuest - 1] || 1;
                                                            const isSuccess = fails < failsRequired;

                                                            return (
                                                                <div className="flex flex-col items-center justify-center space-y-8">
                                                                    <div className="relative">
                                                                        <div className={`absolute inset-0 blur-[100px] animate-pulse ${isSuccess ? 'bg-blue-600/20' : 'bg-red-600/30'}`}></div>

                                                                        <h2 className={`text-7xl md:text-8xl font-cinzel font-black tracking-tighter italic relative z-10 ${!isSuccess ? 'animate-shake text-red-600 text-fail-glow' : 'text-blue-400 text-success-glow'}`}>
                                                                            {isSuccess ? 'SUCCESS' : 'FAILED'}
                                                                        </h2>

                                                                        {/* 衝撃波エフェクト（失敗時のみ激しく動く） */}
                                                                        {!isSuccess && (
                                                                            <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[120%] h-[120%] -z-10">
                                                                                <div className="absolute inset-0 border-2 border-red-500/20 rounded-full animate-ping"></div>
                                                                            </div>
                                                                        )}
                                                                    </div>

                                                                    <div className="text-center space-y-4">
                                                                        <p className={`text-xl font-bold tracking-[0.3em] uppercase ${isSuccess ? 'text-blue-400' : 'text-red-500 animate-pulse'}`}>
                                                                            {isSuccess ? "遠征は完遂された" : "遠征は闇に侵食された"}
                                                                        </p>

                                                                        <div className="flex flex-col gap-1 items-center opacity-60">
                                                                            <p className="text-[10px] text-white uppercase tracking-[0.2em] font-medium">
                                                                                {fails} Failure card(s) detected
                                                                            </p>
                                                                            <p className="text-[9px] text-gray-500 italic tracking-[0.2em]">
                                                                                — {isSuccess ? "Archiving Victory to Chronicle..." : "The Sabotage was Successful."} —
                                                                            </p>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })()}
                                                    </div>
                                                )}
                                            </div>
                                        ) : (
                                            /* --- 既存のUI（待機中 or ボタン操作） --- */
                                            <>
                                                <div className="mb-2">
                                                    <p className="text-[10px] text-gray-500 uppercase tracking-widest mb-2">Quest Progress</p>
                                                    <div className="py-6 bg-black/40 rounded-lg border border-white/5">
                                                        <div className="relative inline-block">
                                                            <div className="animate-spin inline-block w-8 h-8 border-[3px] border-gold/20 border-t-gold rounded-full"></div>
                                                        </div>
                                                        <p className="text-xs text-gold mt-4 font-cinzel tracking-widest animate-pulse">
                                                            ENVOYS ARE CHOOSING FATE...
                                                        </p>
                                                        <p className="text-[10px] text-gray-500 mt-1">（遠征メンバーが運命を選択中）</p>
                                                    </div>
                                                </div>

                                                {gameState.proposedTeam.includes(myName) ? (
                                                    <div className="space-y-4 pt-4 border-t border-gray-800">
                                                        <p className="text-xs font-bold text-blue-400">
                                                            {hasActioned ? "意思表示を完了しました" : "あなたの運命を選択してください"}
                                                        </p>

                                                        {!hasActioned && (
                                                            <div className="flex flex-col gap-2">
                                                                {!questConfirm ? (
                                                                    /* 選択ボタン */
                                                                    <div className="flex gap-4">
                                                                        <button
                                                                            onClick={() => setQuestConfirm('success')}
                                                                            className="flex-1 py-5 rounded-none font-bold transition-all border bg-blue-900/40 border-blue-500 text-blue-100 hover:bg-blue-600"
                                                                        >
                                                                            成 功
                                                                        </button>
                                                                        <button
                                                                            onClick={() => setQuestConfirm('fail')}
                                                                            className="flex-1 py-5 rounded-none font-bold transition-all border bg-red-900/40 border-red-500 text-red-100 hover:bg-red-600"
                                                                        >
                                                                            失 敗
                                                                        </button>
                                                                    </div>
                                                                ) : (
                                                                    /* 確認ダイアログ（統合） */
                                                                    <div className="p-4 bg-black/60 border border-gold/50 rounded flex flex-col items-center space-y-3 animate-fadeIn">
                                                                        <p className="text-sm text-gold font-bold">
                                                                            【最終確認】 本当に <span className={questConfirm === 'success' ? "text-blue-400" : "text-red-500"}>{questConfirm === 'success' ? '成功' : '失敗'}</span> を出しますか？
                                                                        </p>
                                                                        <div className="flex gap-2 w-full">
                                                                            <button onClick={() => setQuestConfirm(null)} className="flex-1 py-2 bg-gray-700 text-xs rounded text-white font-bold">キャンセル</button>
                                                                            <button
                                                                                onClick={() => { questAction(questConfirm); setQuestConfirm(null); }}
                                                                                className={`flex-1 py-2 text-xs rounded font-bold text-white ${questConfirm === 'success' ? 'bg-blue-600' : 'bg-red-600'}`}
                                                                            >
                                                                                確定して送信
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}

                                                        {hasActioned && (
                                                            <div className="py-4 bg-gray-900/50 rounded animate-pulse">
                                                                <p className="text-xs text-gray-500 uppercase tracking-widest font-bold">ACTION SUBMITTED</p>
                                                            </div>
                                                        )}

                                                        <p className="text-[10px] text-gray-500 italic leading-tight px-4 bg-gray-900/50 py-2 rounded">
                                                            ※正義の陣営（善側）は、どちらのボタンを選択しても自動的に「成功」として集計されます。
                                                        </p>
                                                    </div>
                                                ) : (
                                                    <div className="py-10 text-xs text-gray-500 border-t border-gray-800 italic">
                                                        あなたは遠征を見守っています...<br />
                                                        (審判の時を待て)
                                                    </div>
                                                )}
                                            </>
                                        )}
                                    </div>
                                )}

                                {/* 暗殺フェーズ (assassination) */}
                                {gameState.phase === 'assassination' && (
                                    <div className="bg-red-950/10 p-6 rounded-lg border-l-4 border-red-600 shadow-2xl min-h-[180px] flex flex-col justify-center animate-fadeIn relative overflow-hidden">

                                        {/* 背景の警告演出：赤いパルス */}
                                        <div className="absolute inset-0 bg-red-600/5 animate-pulse pointer-events-none"></div>

                                        <div className="relative z-10 text-center space-y-6">
                                            <div className="space-y-1">
                                                <p className="text-red-500 font-cinzel text-xs tracking-[0.4em] font-bold">THE FINAL STRIKE</p>
                                                <p className="text-xs text-red-200/60 font-bold tracking-widest uppercase">― 暗殺フェーズ ―</p>
                                            </div>

                                            {gameState.playerMap[myName] === '暗殺者' ? (
                                                <div className="space-y-6 animate-fadeIn">
                                                    <div className="space-y-2">
                                                        <p className="text-sm text-white font-bold tracking-tighter">真の預言者（マーリン）は誰か。その喉元を貫け。</p>
                                                        <p className="text-[9px] text-red-400 uppercase tracking-widest italic opacity-70">Designate the Prophet of Camelot</p>
                                                    </div>

                                                    <div className="grid grid-cols-2 gap-3 max-w-xs mx-auto">
                                                        {/* 暗殺者以外（ターゲット候補）をリストアップ */}
                                                        {gameState.playerList.filter(p => p !== myName).map(p => (
                                                            <button
                                                                key={p}
                                                                onClick={() => setAssassinationTarget(p)}
                                                                className="group relative py-3 bg-black border border-red-900/50 rounded-sm overflow-hidden transition-all hover:border-red-500 active:scale-95 shadow-lg"
                                                            >
                                                                {/* ホバー時の照準演出 */}
                                                                <div className="absolute inset-0 bg-red-600/10 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                                                                <div className="relative z-10 flex flex-col items-center">
                                                                    <span className="text-[10px] text-gray-400 group-hover:text-white transition-colors tracking-widest font-bold">{p}</span>
                                                                    <span className="text-[7px] text-red-700 uppercase font-black tracking-tighter mt-0.5 group-hover:text-red-400">Target</span>
                                                                </div>
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                            ) : (
                                                /* 暗殺者以外の待機画面 */
                                                <div className="py-8 space-y-4 animate-pulse">
                                                    <div className="flex justify-center gap-4">
                                                        <div className="w-1 h-8 bg-red-600/30"></div>
                                                        <div className="w-1 h-8 bg-red-600/60"></div>
                                                        <div className="w-1 h-8 bg-red-600/30"></div>
                                                    </div>
                                                    <div className="space-y-2">
                                                        <p className="text-sm text-red-200 font-bold tracking-[0.2em]">暗殺者が凶刃を研いでいます...</p>
                                                        <p className="text-[10px] text-red-800 font-bold uppercase tracking-widest">Awaiting the assassin's verdict</p>
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        {/* 画面端の警告ライン */}
                                        <div className="absolute bottom-0 left-0 w-full h-[2px] bg-gradient-to-r from-transparent via-red-600/50 to-transparent"></div>
                                    </div>
                                )}

                                {/* 最終結果（勝敗決定）の豪華統合演出 */}
                                {gameState?.phase === 'end' && showEndResult && (
                                    <div className="fixed inset-0 z-[1200] bg-[#050505]/98 flex flex-col items-center justify-center p-6 animate-fadeIn backdrop-blur-xl overflow-hidden">

                                        {/* 背景：勝敗に応じた環境光（統合されたエフェクト） */}
                                        <div className={`absolute inset-0 opacity-20 blur-[100px] pointer-events-none ${gameState.winner === 'GOOD' ? 'bg-blue-600' : 'bg-red-600'
                                            }`}></div>

                                        <div className="relative z-10 text-center space-y-6 max-w-sm w-full p-8 border-t border-b border-white/10 shadow-[0_0_100px_rgba(0,0,0,1)]">

                                            {/* メインタイトル */}
                                            <div className="space-y-4 animate-revealIdentity">
                                                <p className={`text-6xl font-cinzel tracking-[0.2em] font-bold ${gameState.winner === 'GOOD' ? 'text-blue-400 text-success-glow' : 'text-red-600 text-fail-glow animate-shake'
                                                    }`}>
                                                    {gameState.winner === 'GOOD' ? 'VICTORY' : 'DEFEAT'}
                                                </p>
                                                <div className="space-y-1">
                                                    <p className="text-xl font-bold text-white tracking-[0.3em] uppercase">
                                                        {gameState.winner === 'GOOD' ? '正義の成就' : '邪悪の浸食'}
                                                    </p>
                                                    <p className="text-[9px] text-gray-500 uppercase tracking-[0.4em] font-cinzel">The Prophecy has been Fulfilled</p>
                                                </div>
                                            </div>

                                            {/* 決着の理由：物語の断片 */}
                                            <div className="relative py-3 px-6 bg-white/[0.03] border border-white/10 inline-block shadow-inner">
                                                <p className="text-[11px] text-gold/80 font-bold tracking-[0.2em] leading-relaxed">
                                                    {gameState.winner === 'EVIL' ? (
                                                        gameState.assassinationResult === 'success'
                                                            ? "暗殺者の刃が、キャメロットの予言者を貫いた"
                                                            : "遠征は失敗を重ね、王国の灯火は潰えた"
                                                    ) : (
                                                        "遠征は完遂され、真実の盾が予言者を守り抜いた"
                                                    )}
                                                </p>
                                            </div>

                                            {/* 真実の記録：Archive of Truth（データ統合部分） */}
                                            <div className="bg-black/60 p-5 rounded-sm border border-white/10 space-y-4 shadow-2xl">
                                                <div className="flex items-center justify-between border-b border-white/10 pb-2">
                                                    <span className="text-[9px] text-gold/60 font-cinzel tracking-[0.2em] uppercase font-bold">Archive of Truth</span>
                                                    <span className="text-[8px] text-gray-600 tracking-widest uppercase font-bold">真実の記録</span>
                                                </div>
                                                <div className="space-y-2 max-h-[25vh] overflow-y-auto custom-scrollbar pr-2 text-left">
                                                    {Object.entries(gameState.playerMap || {}).map(([name, role]) => (
                                                        <div key={name} className="flex justify-between items-center border-b border-white/5 py-2 group">
                                                            <div className="flex items-center gap-2">
                                                                <div className={`w-1 h-1 rotate-45 ${['暗殺者', 'モルガナ', 'モードレッド', 'オベロン'].includes(role) ? 'bg-red-600' : 'bg-blue-500'
                                                                    }`}></div>
                                                                <span className="text-gray-200 text-sm font-medium tracking-wider group-hover:text-white transition-colors">{name}</span>
                                                            </div>
                                                            <span className={`font-cinzel text-xs font-black tracking-widest ${['暗殺者', 'モルガナ', 'モードレッド', 'オベロン'].includes(role) ? 'text-red-500' : 'text-blue-400'
                                                                }`}>
                                                                {role}
                                                            </span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>

                                            {/* アクションボタン */}
                                            <div className="pt-4 space-y-3">
                                                <button
                                                    onClick={() => setShowEndResult(false)}
                                                    className="w-full py-3 bg-blue-900/20 border border-blue-500/40 text-blue-200 font-bold text-[10px] tracking-[0.2em] hover:bg-blue-600/30 transition-all rounded-sm uppercase active:scale-95"
                                                >
                                                    戦績を詳しく確認する (演出を閉じる)
                                                </button>

                                                <button
                                                    onClick={handleReset}
                                                    className="w-full py-4 bg-white/5 border border-white/20 text-gray-400 font-cinzel text-[10px] tracking-[0.5em] hover:bg-red-900/20 hover:text-red-400 transition-all rounded-sm uppercase font-bold"
                                                >
                                                    タイトルへ戻る
                                                </button>
                                            </div>
                                        </div>

                                        {/* 画面端のヴィネット効果（終焉の静寂） */}
                                        <div className="absolute inset-0 pointer-events-none shadow-[inset_0_0_150px_rgba(0,0,0,1)]"></div>
                                    </div>
                                )}
                            </div>
                            {/* 戦況監視コンソール (Game Logs) */}
                            <div className="relative group">
                                {/* ログエリアのラベル */}
                                <div className="flex justify-between items-center mb-1 px-1">
                                    <span className="text-[9px] text-gold/40 font-cinzel tracking-widest uppercase">Battle Console</span>
                                    <span className="text-[7px] text-white/10 tracking-tighter italic">LIVE FEED</span>
                                </div>

                                <div className="bg-black/80 p-3 h-40 overflow-y-auto rounded-sm border border-white/5 space-y-2 shadow-inner custom-scrollbar relative">
                                    {/* 背景に薄く流れるグリッド（デジタル感の演出） */}
                                    <div className="absolute inset-0 opacity-[0.02] pointer-events-none bg-[length:20px_20px] bg-[linear-gradient(to_right,#fff_1px,transparent_1px),linear-gradient(to_bottom,#fff_1px,transparent_1px)]"></div>

                                    <div className="relative z-10">
                                        {gameState.logs?.map((l, i) => (
                                            <div
                                                key={i}
                                                className={`border-b border-white/[0.03] pb-1.5 mb-1.5 transition-all duration-500 ${i === 0 ? 'text-gold brightness-125 animate-fadeIn' : 'text-gray-500'
                                                    }`}
                                            >
                                                <div className="flex gap-2 items-start">
                                                    {/* 配列の0番目（最新）にだけ「▶」を表示 */}
                                                    <span className={`text-[8px] mt-0.5 ${i === 0 ? 'text-gold' : 'text-gold/20'}`}>
                                                        {i === 0 ? '▶' : '▷'}
                                                    </span>
                                                    <p className="text-[10px] leading-relaxed tracking-wider font-medium">
                                                        {l}
                                                    </p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* ログエリア下部のスキャンライン装飾 */}
                                <div className="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-t from-gold/5 to-transparent pointer-events-none"></div>
                            </div>
                        </div>
                    )}
                    {/* 聖戦開始の最終確認モーダル */}
                    {showStartConfirm && (
                        <div className="fixed inset-0 z-[1100] bg-black/95 flex items-center justify-center p-6 animate-fadeIn backdrop-blur-sm">
                            <div className="relative bg-[#1a1a1e] border-2 border-blue-500/50 p-6 w-full max-w-sm shadow-[0_0_50px_rgba(59,130,246,0.2)] space-y-6">

                                {/* 装飾用：青い光の帯 */}
                                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-50"></div>

                                <div className="text-center space-y-2">
                                    <h4 className="font-cinzel text-blue-400 text-xl tracking-[0.2em] font-bold">FINAL DECREE</h4>
                                    <p className="text-[10px] text-blue-500/60 uppercase tracking-[0.3em] font-bold">盟約の最終確認</p>
                                </div>

                                <div className="bg-black/60 border border-white/5 p-4 space-y-4 rounded-sm">
                                    <div className="space-y-1">
                                        <p className="text-[9px] text-gray-500 uppercase tracking-widest">Deployment Scale</p>
                                        <p className="text-sm font-bold text-white tracking-widest">遠征規模: {pCount} 名</p>
                                    </div>
                                    <div className="space-y-1">
                                        <p className="text-[9px] text-gray-500 uppercase tracking-widest">Roles Alignment</p>
                                        <div className="flex flex-wrap gap-1.5">
                                            {selectedRoles.map((role, idx) => (
                                                <span key={idx} className="text-[9px] bg-blue-900/20 border border-blue-500/30 px-1.5 py-0.5 text-blue-300 rounded-px">
                                                    {role}
                                                </span>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                <p className="text-xs text-gray-400 leading-relaxed text-center italic">
                                    「この運命を受け入れ、戦いの幕を上げますか？」
                                </p>

                                <div className="flex gap-3 pt-2">
                                    <button
                                        onClick={() => setShowStartConfirm(false)}
                                        className="flex-1 py-3 border border-white/10 text-gray-500 text-[10px] font-bold uppercase tracking-widest hover:bg-white/5 transition-all"
                                    >
                                        再検討
                                    </button>
                                    <button
                                        onClick={() => {
                                            setShowStartConfirm(false);
                                            startGame();
                                        }}
                                        className="flex-1 py-3 bg-blue-600 border border-blue-400 text-white text-[10px] font-black uppercase tracking-[0.2em] shadow-[0_0_20px_rgba(59,130,246,0.4)] active:scale-95 transition-all"
                                    >
                                        聖戦開始
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    {/* 全履歴モーダル */}
                    {showHistoryModal && (
                        <div className="fixed inset-0 z-[700] flex items-center justify-center p-4 backdrop-blur-xl animate-fadeIn">
                            <div className="absolute inset-0 bg-black/90" onClick={() => setShowHistoryModal(false)}></div>

                            <div className="relative bg-[#0a0a0c] border border-white/10 w-full max-w-md max-h-[85vh] overflow-hidden flex flex-col shadow-[0_0_50px_rgba(0,0,0,1)]">

                                {/* ヘッダー */}
                                <div className="p-5 border-b border-white/5 bg-white/[0.02] flex justify-between items-center">
                                    <div className="space-y-1">
                                        <h3 className="font-cinzel text-sm gold-text tracking-[0.3em] font-bold">KINGDOM ARCHIVES</h3>
                                        <p className="text-[8px] text-white/20 uppercase tracking-widest font-bold">聖戦の全記録</p>
                                    </div>
                                    <button onClick={() => setShowHistoryModal(false)} className="text-white/20 hover:text-white transition-colors text-2xl font-light">&times;</button>
                                </div>

                                {/* タブ切り替えスイッチ */}
                                <div className="flex bg-black/40">
                                    {[
                                        { id: 'quest', label: 'Quest Logs', sub: '遠征記録', color: 'text-gold' },
                                        { id: 'vote', label: 'Vote Logs', sub: '評決記録', color: 'text-blue-400' }
                                    ].map(tab => (
                                        <button
                                            key={tab.id}
                                            onClick={() => setHistoryTab(tab.id)}
                                            className={`flex-1 py-4 flex flex-col items-center transition-all relative ${historyTab === tab.id ? tab.color + ' bg-white/[0.03]' : 'text-gray-600 opacity-50 grayscale'
                                                }`}
                                        >
                                            <span className="text-[10px] font-bold uppercase tracking-[0.2em] font-cinzel">{tab.label}</span>
                                            <span className="text-[7px] font-bold tracking-widest mt-1">{tab.sub}</span>
                                            {historyTab === tab.id && <div className={`absolute bottom-0 left-0 w-full h-0.5 ${tab.id === 'quest' ? 'bg-gold' : 'bg-blue-400'}`}></div>}
                                        </button>
                                    ))}
                                </div>

                                {/* コンテンツエリア */}
                                <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar bg-[radial-gradient(circle_at_top,rgba(255,255,255,0.02)_0%,transparent_100%)]">
                                    {historyTab === 'quest' ? (
                                        /* --- 遠征ログ（最新が上） --- */
                                        <div className="space-y-6 animate-fadeIn">
                                            {gameState.questHistory?.length > 0 ? (
                                                [...gameState.questHistory].reverse().map((qh, i, arr) => {
                                                    const questNum = arr.length - i;
                                                    return (
                                                        <div key={i} className="group relative">
                                                            <div className={`p-4 bg-white/[0.02] border border-white/5 rounded-sm transition-all ${qh.result === 'success' ? 'border-l-blue-500/50' : 'border-l-red-500/50'}`}>
                                                                <div className="flex justify-between items-start mb-4">
                                                                    <div className="space-y-1">
                                                                        <span className="text-[11px] text-gold/80 font-cinzel tracking-[0.2em] font-bold">QUEST 0{questNum}</span>
                                                                        <p className="text-[8px] text-white/20 uppercase font-bold tracking-tighter">Mission Chronicle</p>
                                                                    </div>
                                                                    <div className={`px-3 py-1 rounded-sm text-[9px] font-black tracking-[0.2em] ${qh.result === 'success' ? 'bg-blue-900/40 text-blue-400 border border-blue-500/20' : 'bg-red-900/40 text-red-500 border border-red-500/20'}`}>
                                                                        {qh.result === 'success' ? "SUCCESS" : "FAILED"}
                                                                    </div>
                                                                </div>

                                                                {/* 遠征メンバーの表示 */}
                                                                <div className="space-y-3">
                                                                    <div className="flex flex-wrap gap-2">
                                                                        {qh.team.map(member => (
                                                                            <span key={member} className="text-[10px] px-2 py-1 bg-black/60 text-gray-400 border border-white/5 font-medium">{member}</span>
                                                                        ))}
                                                                    </div>
                                                                    <div className="pt-3 border-t border-white/5 flex justify-between items-center">
                                                                        <span className="text-[8px] text-white/20 font-bold uppercase tracking-widest italic">Result Breakdown</span>
                                                                        <span className="text-[10px] text-gray-500 font-mono tracking-widest uppercase">{qh.details}</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    );
                                                })
                                            ) : <div className="text-center py-20 text-[10px] text-gray-600 uppercase tracking-widest italic">No chronicle found.</div>}
                                        </div>
                                    ) : (
                                        /* --- 投票ログ（最新が上） --- */
                                        <div className="space-y-6 animate-fadeIn">
                                            {gameState.voteHistory?.length > 0 ? (
                                                [...gameState.voteHistory].reverse().map((vh, i) => (
                                                    <div key={i} className="space-y-2">
                                                        <div className={`p-4 bg-white/[0.02] border border-white/5 rounded-sm ${vh.approved ? "border-l-green-600/50 shadow-[inset_4px_0_10px_rgba(22,163,74,0.05)]" : "border-l-gray-800"}`}>
                                                            <div className="flex justify-between items-start mb-3">
                                                                <div className="space-y-1">
                                                                    <span className="text-[10px] text-gray-400 font-bold tracking-[0.1em] uppercase">Quest {vh.quest} — Attempt {vh.count}</span>
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="text-[8px] text-gold font-bold font-cinzel tracking-widest opacity-60">LEADER :</span>
                                                                        <span className="text-xs text-white font-black tracking-wider underline decoration-gold/30 underline-offset-4">{vh.leader}</span>
                                                                    </div>
                                                                </div>
                                                                <span className={`text-[10px] font-black tracking-widest ${vh.approved ? "text-green-500" : "text-red-500"}`}>
                                                                    {vh.approved ? "APPROVED" : "REJECTED"}
                                                                </span>
                                                            </div>

                                                            {/* 提案されたチームの可視化 */}
                                                            <div className="mb-4 p-2 bg-black/40 border border-white/5 flex flex-wrap gap-1.5 items-center">
                                                                <span className="text-[8px] text-white/20 font-bold uppercase mr-1">Proposed:</span>
                                                                {vh.team?.map(m => (
                                                                    <span key={m} className="text-[9px] text-gray-300 font-bold">{m}</span>
                                                                )) || <span className="text-[9px] text-gray-600 italic">No team data</span>}
                                                            </div>

                                                            {/* 投票の内訳を見やすく整理：グリッド形式 */}
                                                            <div className="space-y-2">
                                                                <p className="text-[8px] text-gold/40 font-bold uppercase tracking-widest border-b border-white/5 pb-1">Vote Detail Log</p>
                                                                <div className="grid grid-cols-2 xs:grid-cols-3 gap-x-4 gap-y-1.5 p-2 bg-black/20 font-mono">
                                                                    {vh.details.split("  ").map((vote, vi) => {
                                                                        const [vname, vsign] = vote.split(":");
                                                                        const isVApproved = vsign === '○';
                                                                        return (
                                                                            <div key={vi} className="flex items-center justify-between overflow-hidden">
                                                                                <span className="text-[9px] text-gray-500 truncate mr-2">{vname}</span>
                                                                                <div className={`w-1 h-1 rounded-full ${isVApproved ? 'bg-green-500 shadow-[0_0_4px_rgba(34,197,94,1)]' : 'bg-red-600'}`}></div>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))
                                            ) : <div className="text-center py-20 text-[10px] text-gray-600 uppercase tracking-widest italic">No verdict records found.</div>}
                                        </div>
                                    )}
                                </div>

                                {/* フッター */}
                                <button
                                    onClick={() => setShowHistoryModal(false)}
                                    className="w-full py-5 bg-white/5 border-t border-white/10 text-white text-[10px] font-bold uppercase tracking-[0.4em] hover:bg-white/10 transition-all font-cinzel active:scale-95"
                                >
                                    Return to Command
                                </button>
                            </div>
                        </div>
                    )}

                    {/* 役職ヘルプモーダル */}
                    {showHelp && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-6">
                            <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" onClick={() => setShowHelp(false)}></div>
                            <div className="relative bg-[#1a1a1e] border-2 border-[#c5a059] p-6 w-full max-w-sm shadow-[0_0_50px_rgba(197,160,89,0.2)] animate-fadeIn">
                                {/* 役職名と解説 */}
                                <h4 className="font-cinzel gold-text text-xl mb-1 tracking-wider">{gameState.playerMap?.[myName]}</h4>
                                <p className="text-[10px] text-gold/60 uppercase tracking-widest mb-3 border-b border-gold/20 pb-1">Role Instruction</p>

                                <p className="text-sm text-gray-300 leading-relaxed mb-6 italic">
                                    {ROLE_HELP[gameState.playerMap?.[myName]]}
                                </p>

                                {/* 陣営の相関（ナレッジ）部分を整理 */}
                                <div className="space-y-3 mb-8 bg-black/40 p-3 border border-white/5 rounded">
                                    <p className="text-[10px] text-gold uppercase tracking-tighter flex items-center gap-2">
                                        <span className="w-1 h-1 bg-gold rotate-45"></span> 啓示される情報
                                    </p>

                                    <div className="text-xs leading-relaxed">
                                        {gameState.playerMap?.[myName] === 'マーリン' && (
                                            <p className="text-red-400">邪悪な者の正体を知っている。<br /><span className="text-[10px] text-gray-500">※モードレッドの姿は見えません。</span></p>
                                        )}
                                        {gameState.playerMap?.[myName] === 'パーシヴァル' && (
                                            <p className="text-blue-400">マーリンを自称する者（マーリンとモルガナ）が見える。</p>
                                        )}
                                        {['暗殺者', 'モルガナ', 'モードレッド'].includes(gameState.playerMap?.[myName]) && (
                                            <p className="text-red-400">自分以外の邪悪な仲間の正体を知っている。<br /><span className="text-[10px] text-gray-500">※オベロンの姿は見えません。</span></p>
                                        )}
                                        {['忠臣', 'オベロン'].includes(gameState.playerMap?.[myName]) && (
                                            <p className="text-gray-500">あなたに与えられる予備知識はありません。</p>
                                        )}
                                    </div>
                                </div>

                                <button
                                    onClick={() => setShowHelp(false)}
                                    className="w-full py-3 bg-gradient-to-b from-[#c5a059] to-[#8e6d2f] text-black font-bold text-xs uppercase tracking-[0.2em] hover:brightness-125 transition-all shadow-lg"
                                >
                                    閉じる
                                </button>
                            </div>
                        </div>
                    )}

                    {/* 役職判明演出モーダル */}
                    {isRevealingRole && gameState?.playerMap?.[myName] && (
                        <div className="fixed inset-0 z-[1000] bg-[#050505] flex flex-col items-center justify-center p-8 animate-fadeIn overflow-hidden">
                            {/* 背景の装飾的エフェクト：陣営によって色が変わる */}
                            <div className={`absolute inset-0 opacity-20 pointer-events-none ${['暗殺者', 'モルガナ', 'モードレッド', 'オベロン'].includes(gameState.playerMap[myName])
                                ? 'bg-[radial-gradient(circle,rgba(220,38,38,0.2)_0%,transparent_70%)]'
                                : 'bg-[radial-gradient(circle,rgba(59,130,246,0.2)_0%,transparent_70%)]'
                                }`}></div>

                            <div className="relative z-10 text-center space-y-10 max-w-xs w-full">
                                <div className="space-y-2">
                                    <h2 className="text-gold font-cinzel text-xs tracking-[0.6em] animate-pulse">IDENTITY ASSIGNED</h2>
                                    <p className="text-[9px] text-gold/40 uppercase tracking-widest font-bold">天命は下された</p>
                                </div>

                                {/* 運命のカード演出 */}
                                <div className="relative w-56 h-80 mx-auto perspective-1000">
                                    <div className={`w-full h-full border-2 rounded-lg flex flex-col items-center justify-center p-8 shadow-2xl animate-cardReveal transition-all duration-1000 ${['暗殺者', 'モルガナ', 'モードレッド', 'オベロン'].includes(gameState.playerMap[myName])
                                        ? 'bg-gradient-to-b from-red-950/40 to-black border-red-600/50 shadow-red-900/20'
                                        : 'bg-gradient-to-b from-blue-950/40 to-black border-blue-600/50 shadow-blue-900/20'
                                        }`}>
                                        {/* カード角の装飾 */}
                                        <div className="absolute top-2 left-2 w-3 h-3 border-t border-l border-gold/30"></div>
                                        <div className="absolute bottom-2 right-2 w-3 h-3 border-b border-r border-gold/30"></div>

                                        <p className="text-[10px] text-gold/60 uppercase tracking-[0.3em] mb-4 font-bold">You Are</p>

                                        <h3 className={`text-4xl font-cinzel font-bold mb-6 text-center tracking-tighter drop-shadow-[0_0_10px_rgba(255,255,255,0.3)] ${['暗殺者', 'モルガナ', 'モードレッド', 'オベロン'].includes(gameState.playerMap[myName])
                                            ? 'text-red-100' : 'text-blue-100'
                                            }`}>
                                            {gameState.playerMap[myName]}
                                        </h3>

                                        <div className="w-16 h-0.5 bg-gold/20 mb-6"></div>

                                        <p className="text-[11px] text-gray-300 leading-relaxed italic font-medium text-center px-2">
                                            {['暗殺者', 'モルガナ', 'モードレッド', 'オベロン'].includes(gameState.playerMap[myName])
                                                ? "邪悪の軍勢として、正義の目を欺き、その大志を闇に葬れ。"
                                                : "アーサー王の忠臣として、聖杯の導きを信じ、邪悪な影を暴き出せ。"}
                                        </p>
                                    </div>
                                </div>

                                <div className="pt-4">
                                    <button
                                        onClick={() => { setIsRevealingRole(false); sessionStorage.setItem(`revealed_${roomCode}`, 'true'); }}
                                        className="w-full group relative py-4 bg-transparent transition-all overflow-hidden border border-white/10 rounded-sm"
                                    >
                                        <div className="absolute inset-0 bg-white/5 group-hover:bg-white/10 transition-colors"></div>
                                        <span className="relative z-10 text-white font-cinzel text-xs tracking-[0.4em] group-hover:text-gold transition-colors">
                                            ACCEPT FATE
                                        </span>
                                        <p className="relative z-10 text-[8px] text-white/30 uppercase mt-1 tracking-widest font-bold">天命を受け入れる</p>
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    {/* 投票結果の全画面演出 */}
                    {isRevealingVote && (
                        <div className="fixed inset-0 z-[280] flex flex-col items-center justify-center animate-fadeIn backdrop-blur-md bg-black/60">
                            {/* max-w-xs (約320px) に制限し、横幅が広がりすぎないように設定 */}
                            <div className={`relative w-[85%] max-w-xs transition-all duration-700 p-6 border-t border-b border-white/20 shadow-[0_0_50px_rgba(0,0,0,0.8)] flex flex-col items-center
            ${lastVoteStatus === 'approved'
                                    ? 'bg-blue-950/90 shadow-blue-900/20'
                                    : 'bg-red-950/90 shadow-red-900/20'
                                }`}
                            >
                                {/* 装飾用角パーツ（上下） */}
                                <div className={`absolute top-0 left-0 w-2 h-2 border-t border-l ${lastVoteStatus === 'approved' ? 'border-blue-400' : 'border-red-500'}`}></div>
                                <div className={`absolute bottom-0 right-0 w-2 h-2 border-b border-r ${lastVoteStatus === 'approved' ? 'border-blue-400' : 'border-red-500'}`}></div>

                                <h2 className={`font-cinzel text-3xl tracking-[0.3em] font-bold animate-cardReveal
                ${lastVoteStatus === 'approved' ? 'text-blue-100 text-success-glow' : 'text-red-100 text-fail-glow'}`}
                                >
                                    {lastVoteStatus === 'approved' ? 'APPROVED' : 'REJECTED'}
                                </h2>

                                <p className="text-[10px] mt-4 tracking-[0.2em] font-bold uppercase text-white/80 animate-pulse">
                                    {lastVoteStatus === 'approved' ? '— 遠征部隊、出発 —' : '— 提案は退けられた —'}
                                </p>
                            </div>

                            {/* 背景の光の筋（さらに細く） */}
                            <div className={`absolute inset-0 -z-10 opacity-30 pointer-events-none 
            ${lastVoteStatus === 'approved'
                                    ? 'bg-[radial-gradient(circle,rgba(59,130,246,0.15)_0%,transparent_70%)]'
                                    : 'bg-[radial-gradient(circle,rgba(239,68,68,0.15)_0%,transparent_70%)]'}`}>
                            </div>
                        </div>
                    )}

                    {/* マッチポイント遠征の激アツカットイン */}
                    {isMatchPointPerforming && (
                        <div className="fixed inset-0 z-[500] bg-[#050505] flex flex-col items-center justify-center overflow-hidden">

                            {/* 背景：激しいエネルギーの渦を演出 */}
                            <div className="absolute inset-0 bg-[radial-gradient(circle,rgba(197,160,89,0.15)_0%,transparent_70%)] animate-pulse"></div>
                            <div className="absolute inset-0 border-[1px] border-gold/20 animate-[ping_3s_linear_infinite]"></div>
                            <div className="absolute inset-0 border-[40px] border-double border-gold/5 opacity-20"></div>

                            <div className="relative z-10 text-center space-y-6">
                                {/* 上部タイトル：Cinzelフォントで神話的な響きを */}
                                <div className="space-y-2 animate-bounce">
                                    <p className="text-gold font-cinzel text-xl tracking-[0.6em] drop-shadow-[0_0_10px_rgba(197,160,89,0.5)]">
                                        FINAL CRITICAL QUEST
                                    </p>
                                    <div className="h-[2px] w-32 bg-gradient-to-r from-transparent via-gold to-transparent mx-auto"></div>
                                </div>

                                {/* メインタイトル：圧倒的な存在感（中央揃え・レスポンシブ対応） */}
                                <div className="relative py-4 w-full flex flex-col items-center justify-center">
                                    <h2 className="text-4xl sm:text-6xl md:text-8xl font-cinzel font-bold text-white italic tracking-[0.1em] sm:tracking-tighter animate-revealIdentity drop-shadow-[0_0_30px_rgba(255,255,255,0.4)] text-center leading-tight">
                                        運命の審判
                                    </h2>
                                    {/* 文字の後ろで輝く後光：幅を文字に合わせる */}
                                    <div className="absolute inset-0 -z-10 bg-gold/20 blur-[60px] animate-pulse max-w-xs mx-auto"></div>
                                </div>

                                {/* 中央：二つの勢力の激突を象徴する回転体 */}
                                <div className="py-8 flex items-center justify-center gap-8 relative">
                                    <div className="w-16 h-16 rounded-full border-b-4 border-l-4 border-blue-500 shadow-[0_0_20px_rgba(59,130,246,0.5)] animate-spin"></div>
                                    <div className="text-2xl font-cinzel text-gold font-bold animate-pulse">VS</div>
                                    <div className="w-16 h-16 rounded-full border-t-4 border-r-4 border-red-600 shadow-[0_0_20px_rgba(220,38,38,0.5)] animate-[spin_1s_linear_infinite_reverse]"></div>

                                    {/* 衝突地点の閃光エフェクト */}
                                    <div className="absolute inset-0 flex items-center justify-center">
                                        <div className="w-1 h-20 bg-white blur-sm opacity-50 rotate-[20deg] animate-pulse"></div>
                                    </div>
                                </div>

                                {/* 下部テキスト：プレイヤーへの語りかけ */}
                                <div className="space-y-3">
                                    <p className="text-lg text-white/90 font-bold tracking-[0.3em] animate-pulse">
                                        世界は、どちらの色に染まるのか。
                                    </p>
                                    <div className="flex flex-col gap-1 items-center opacity-60">
                                        <p className="text-[10px] text-gold uppercase tracking-[0.2em] font-medium">
                                            The wheel of fate begins to turn.
                                        </p>
                                        <p className="text-[9px] text-white italic tracking-widest">
                                            — 運命の歯車が、いま回り出す —
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* 画面を斜めに切り裂く高速の光線 */}
                            <div className="absolute top-0 left-[-150%] w-[400%] h-full bg-gradient-to-r from-transparent via-white/30 to-transparent rotate-[30deg] animate-[shimmer_1.5s_infinite]"></div>

                            {/* 画面端のヴィネット（暗縁）効果で集中力を高める */}
                            <div className="absolute inset-0 pointer-events-none shadow-[inset_0_0_150px_rgba(0,0,0,0.9)]"></div>
                        </div>
                    )}

                    {/* 暗殺開始の警告演出 */}
                    {isRevealingAssassination && (
                        <div className="fixed inset-0 z-[250] bg-[#0a0000]/95 flex flex-col items-center justify-center p-8 animate-fadeIn backdrop-blur-xl overflow-hidden">

                            {/* 背景演出：画面を侵食する赤い霧とノイズ */}
                            <div className="absolute inset-0 bg-[radial-gradient(circle,rgba(153,27,27,0.3)_0%,transparent_70%)] animate-pulse"></div>
                            <div className="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]"></div>

                            {/* 四隅の警告フレーム：赤い光線 */}
                            <div className="absolute top-0 left-0 w-full h-full border-[12px] border-red-950/20 pointer-events-none shadow-[inset_0_0_100px_rgba(153,27,27,0.2)]"></div>

                            <div className="relative z-10 text-center space-y-10 max-w-xs">
                                {/* 凶刃のシンボル：CSSで描く鋭利なライン */}
                                <div className="relative flex justify-center mb-8">
                                    <div className="relative w-1 h-20 bg-gradient-to-b from-red-600 via-red-500 to-transparent animate-bounce">
                                        {/* 刃の輝き */}
                                        <div className="absolute top-0 left-1/2 -translate-x-1/2 w-4 h-4 bg-white blur-md opacity-50 animate-pulse"></div>
                                    </div>
                                    {/* 刃のつば部分 */}
                                    <div className="absolute top-4 w-10 h-[1px] bg-red-800"></div>
                                </div>

                                <div className="w-full flex flex-col items-center justify-center px-4 space-y-2">
                                    {/* メインタイトル */}
                                    <h2 className="text-white font-cinzel text-2xl sm:text-3xl md:text-4xl tracking-[0.2em] sm:tracking-[0.4em] font-bold drop-shadow-[0_0_15px_rgba(255,0,0,0.5)] text-center leading-tight">
                                        ASSASSINATION
                                    </h2>

                                    {/* サブタイトル：The Last Strike */}
                                    <div className="flex justify-center items-center gap-4">
                                        <span className="h-[1px] w-8 sm:w-12 bg-gradient-to-r from-transparent to-red-600"></span>
                                        <p className="text-[10px] text-red-500 font-cinzel tracking-[0.3em] sm:tracking-[0.5em] uppercase font-bold whitespace-nowrap">
                                            The Last Strike
                                        </p>
                                        <span className="h-[1px] w-8 sm:w-12 bg-gradient-to-l from-transparent to-red-600"></span>
                                    </div>
                                </div>
                                {/* メインコピー：絶望と期待を煽る */}
                                <div className="space-y-4">
                                    <p className="text-2xl text-red-100 font-bold tracking-[0.2em] animate-revealIdentity">
                                        邪悪の逆転劇が、幕を開ける
                                    </p>
                                    <div className="flex flex-col gap-1 items-center opacity-70">
                                        <p className="text-[10px] text-red-400 uppercase tracking-widest font-medium animate-pulse">
                                            Targeting the Prophet of Camelot...
                                        </p>
                                        <p className="text-[9px] text-white/40 italic tracking-widest">
                                            — キャメロットの予言者を屠れ —
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* 画面を走る赤いスキャンライン（ノイズ） */}
                            <div className="absolute top-0 left-0 w-full h-1 bg-red-600/20 animate-[scanline_4s_linear_infinite]"></div>

                            {/* 画面全体が脈打つような赤いフラッシュ */}
                            <div className="absolute inset-0 pointer-events-none animate-pulse bg-red-900/5"></div>
                        </div>
                    )}
                    {/* 暗殺最終確認モーダル */}
                    {assassinationTarget && (
                        <div className="fixed inset-0 z-[1300] bg-black/90 flex items-center justify-center p-6 animate-fadeIn backdrop-blur-md">
                            <div className="relative bg-[#1a0505] border-2 border-red-600/50 p-6 w-full max-w-xs shadow-[0_0_50px_rgba(220,38,38,0.2)] space-y-6 text-center">

                                {/* 装飾：血のような赤い光 */}
                                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-red-600 to-transparent opacity-50"></div>

                                <div className="space-y-2">
                                    <h4 className="font-cinzel text-red-500 text-lg tracking-[0.2em] font-bold">EXECUTION</h4>
                                    <p className="text-[9px] text-red-600/60 uppercase tracking-[0.3em] font-bold font-cinzel">暗殺の最終決断</p>
                                </div>

                                <div className="py-4 border-y border-red-900/30">
                                    <p className="text-xs text-gray-400 mb-2">ターゲット</p>
                                    <p className="text-2xl font-bold text-white tracking-widest underline decoration-red-600 underline-offset-8">
                                        {assassinationTarget}
                                    </p>
                                </div>

                                <p className="text-[10px] text-red-200/60 leading-relaxed italic">
                                    「その者が真にマーリンならば、正義は潰え、我らの勝利となる。引き金。を引くか？」
                                </p>

                                <div className="flex gap-3 pt-2">
                                    <button
                                        onClick={() => setAssassinationTarget(null)}
                                        className="flex-1 py-3 border border-white/10 text-gray-500 text-[10px] font-bold uppercase tracking-widest hover:bg-white/5 transition-all"
                                    >
                                        待機
                                    </button>
                                    <button
                                        onClick={() => {
                                            executeAssassination(assassinationTarget);
                                            setAssassinationTarget(null);
                                        }}
                                        className="flex-1 py-3 bg-red-700 border border-red-500 text-white text-[10px] font-black uppercase tracking-[0.2em] shadow-[0_0_20px_rgba(220,38,38,0.4)] active:scale-95 transition-all"
                                    >
                                        暗殺実行
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 暗殺実行中の最終確認演出 */}
                    {isAssassinating && (
                        <div className="fixed inset-0 z-[400] bg-black flex flex-col items-center justify-center overflow-hidden">

                            {/* 背景：暗闇に溶け込む不穏な赤と、ターゲットをロックオンする走査線 */}
                            <div className="absolute inset-0 bg-[radial-gradient(circle,rgba(153,27,27,0.15)_0%,transparent_80%)] animate-pulse"></div>
                            <div className="absolute inset-0 opacity-20 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] bg-[length:100%_2px,3px_100%]"></div>

                            <div className="relative z-10 text-center space-y-12 w-full max-w-lg">

                                {/* 上部：警告テキスト */}
                                <div className="space-y-2 animate-revealIdentity">
                                    <p className="text-gold font-cinzel text-sm tracking-[0.6em] opacity-80 uppercase">Execution Protocol</p>
                                    <div className="h-[1px] w-24 bg-gradient-to-r from-transparent via-red-600 to-transparent mx-auto"></div>
                                </div>

                                {/* メイン：ターゲット指名 */}
                                <div className="space-y-4">
                                    <p className="text-[10px] text-gray-500 uppercase tracking-[0.4em] font-bold">Designated Target</p>
                                    <h3 className="text-6xl md:text-7xl font-cinzel font-bold text-white tracking-tighter drop-shadow-[0_0_20px_rgba(220,38,38,0.5)]">
                                        <span className="text-red-700">【</span>
                                        {gameState.assassinationTarget}
                                        <span className="text-red-700">】</span>
                                    </h3>
                                </div>

                                {/* 中央：運命のカウントダウン（プログレスバー） */}
                                <div className="space-y-3">
                                    <div className="w-72 h-[2px] bg-white/5 mx-auto relative overflow-hidden">
                                        {/* バーが溜まるのではなく、削れていく演出にすることで「猶予のなさ」を表現 */}
                                        <div className="absolute inset-0 bg-red-600 animate-[loading_5s_linear_forwards]"></div>
                                        {/* バーの先端の光 */}
                                        <div className="absolute top-0 right-0 w-8 h-full bg-white blur-sm animate-[loading_5s_linear_forwards]"></div>
                                    </div>
                                    <p className="text-[10px] text-red-500/60 font-cinzel tracking-[0.3em] uppercase animate-pulse">Calculating Fate...</p>
                                </div>

                                {/* 下部コピー：冷徹な宣告 */}
                                <div className="space-y-4">
                                    <p className="text-xl text-white font-bold italic tracking-[0.2em] animate-pulse">
                                        死の宣告が、下される。
                                    </p>
                                    <div className="flex flex-col gap-1 items-center opacity-40">
                                        <p className="text-[10px] text-white uppercase tracking-widest font-medium">
                                            The blade finds its mark.
                                        </p>
                                        <p className="text-[9px] text-white italic tracking-widest">
                                            — 刃は、その喉元へ —
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* 画面全体を覆う周辺減光と、時折走る赤いノイズ */}
                            <div className="absolute inset-0 pointer-events-none shadow-[inset_0_0_200px_rgba(0,0,0,1)]"></div>
                            <div className="absolute top-0 left-0 w-full h-full pointer-events-none opacity-10 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] animate-pulse"></div>
                        </div>
                    )}
                </div>
            );
        }

        const checkFB = setInterval(() => { if (window.fb) { clearInterval(checkFB); ReactDOM.createRoot(document.getElementById('root')).render(<App />); } }, 100);
    </script>
</body>

</html>
